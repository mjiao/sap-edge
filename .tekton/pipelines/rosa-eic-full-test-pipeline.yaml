# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: rosa-eic-full-test-pipeline
  annotations:
    description: "Complete SAP Edge Integration Cell validation pipeline for ROSA: deploys ROSA HCP with AWS services (RDS PostgreSQL, ElastiCache Redis, S3 for Quay via Terraform), Quay registry operator, runs comprehensive endpoint tests, and tears down infrastructure"
spec:
  params:
    - name: repoUrl
      type: string
    - name: revision
      type: string
    - name: clusterName
      type: string
      description: "ROSA cluster name (max 15 characters)"
    - name: awsRegion
      type: string
      description: "AWS region"
      default: "eu-north-1"
    - name: rosaVersion
      type: string
      description: "ROSA version"
      default: "4.17.0"
    - name: awsSecretName
      type: string
      description: "Name of the Kubernetes Secret containing AWS credentials"
      default: "aws-credentials-secret"
    - name: redhatTokenSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Red Hat OCM token"
      default: "redhat-token-secret"
    - name: eicAuthSecretName
      type: string
      description: "EIC authentication secret name"
    - name: postgresAdminPasswordSecretName
      type: string
      description: "Name of the Kubernetes Secret containing PostgreSQL admin password"
      default: "rosa-postgres-admin-password"
    - name: quayAdminPasswordSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Quay admin password and email"
      default: "quay-admin-secret"
    - name: deployPostgres
      type: string
      description: "Whether to deploy RDS PostgreSQL (true/false)"
      default: "false"
    - name: deployRedis
      type: string
      description: "Whether to deploy ElastiCache Redis (true/false)"
      default: "false"
    - name: deployQuay
      type: string
      description: "Whether to deploy S3 for Quay (true/false)"
      default: "true"
    - name: publicDNS
      type: string
      description: "Use public DNS"
      default: "false"
    - name: terraformStateS3Bucket
      type: string
      description: "S3 bucket name for Terraform state storage"
      default: "eic-test-rosa-terraform-state"
    - name: terraformStateS3Key
      type: string
      description: "S3 key for Terraform state file (auto-generated as rosa/${CLUSTER_NAME}/terraform.tfstate)"
      default: "rosa/terraform.tfstate"
    - name: terraformStateDynamoDBTable
      type: string
      description: "DynamoDB table for Terraform state locking"
      default: "eic-test-rosa-terraform-state-lock"
    - name: jiraSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Jira credentials"
    - name: jiraIssueKey
      type: string
      description: "Jira issue key to update with test results"
  workspaces:
    - name: source
  tasks:
    - name: fetch-repository
      taskRef: { name: git-clone }
      params:
        - name: url
          value: $(params.repoUrl)
        - name: revision
          value: $(params.revision)
        - name: depth
          value: "0"  # Full clone to ensure all refs are available
      workspaces:
        - name: output
          workspace: source

    - name: deploy-rosa
      runAfter: [fetch-repository]
      taskRef: { name: rosa-deploy-with-eic-services }
      params:
        - name: clusterName
          value: $(params.clusterName)
        - name: awsRegion
          value: $(params.awsRegion)
        - name: rosaVersion
          value: $(params.rosaVersion)
        - name: awsSecretName
          value: $(params.awsSecretName)
        - name: redhatTokenSecretName
          value: $(params.redhatTokenSecretName)
        - name: postgresAdminPasswordSecretName
          value: $(params.postgresAdminPasswordSecretName)
        - name: deployPostgres
          value: $(params.deployPostgres)
        - name: deployRedis
          value: $(params.deployRedis)
        - name: deployQuay
          value: $(params.deployQuay)
        - name: terraformStateS3Bucket
          value: $(params.terraformStateS3Bucket)
        - name: terraformStateS3Key
          value: $(params.terraformStateS3Key)
        - name: terraformStateDynamoDBTable
          value: $(params.terraformStateDynamoDBTable)
      workspaces:
        - name: source
          workspace: source

    - name: validate-and-get-access
      runAfter: [deploy-rosa]
      taskRef: { name: rosa-validate-and-get-access }
      params:
        - name: clusterName
          value: $(params.clusterName)
        - name: awsRegion
          value: $(params.awsRegion)
        - name: awsSecretName
          value: $(params.awsSecretName)
        - name: redhatTokenSecretName
          value: $(params.redhatTokenSecretName)
        - name: postgresAdminPasswordSecretName
          value: $(params.postgresAdminPasswordSecretName)
        - name: terraformStateS3Bucket
          value: $(params.terraformStateS3Bucket)
        - name: terraformStateS3Key
          value: $(params.terraformStateS3Key)
        - name: terraformStateDynamoDBTable
          value: $(params.terraformStateDynamoDBTable)
      workspaces:
        - name: source
          workspace: source

    - name: deploy-quay
      runAfter: [validate-and-get-access]
      taskRef: { name: rosa-quay-deploy }
      params:
        - name: clusterName
          value: $(params.clusterName)
        - name: s3BucketName
          value: "$(params.clusterName)-quay-registry"  # Will be retrieved from Terraform
        - name: s3Region
          value: $(params.awsRegion)
        - name: s3Host
          value: "s3.$(params.awsRegion).amazonaws.com"
        - name: awsSecretName
          value: $(params.awsSecretName)
        - name: quayAdminPasswordSecretName
          value: $(params.quayAdminPasswordSecretName)
        - name: redhatTokenSecretName
          value: $(params.redhatTokenSecretName)
      workspaces:
        - name: source
          workspace: source

    # Manual approval gate after ELM/EIC and iFlow deployment
    # After Quay is deployed, pause for manual ELM/EIC/iFlow deployment
    - name: approval-elm-eic-iflow-deployed
      runAfter: [deploy-quay]
      taskRef:
        apiVersion: openshift-pipelines.org/v1alpha1
        kind: ApprovalTask
      params:
        - name: approvers
          value:
            - mjiao
            - rbhandar
            - ksatarin
            - kubeadmin
            - kube:admin
            - system:admin
        - name: description
          value: |
            ROSA cluster, AWS services (RDS PostgreSQL, ElastiCache Redis, S3), and Quay registry are deployed.

            üîß Please complete the following manually:
            1. Deploy Edge Lifecycle Management (ELM)
            2. Deploy Edge Integration Cell (EIC)
            3. Deploy iFlows for testing

            After deployment is complete and istio-ingressgateway has a LoadBalancer IP:
            ‚úÖ APPROVE: Continue to create ConfigMap and run endpoint tests
            ‚ùå REJECT: Skip tests and proceed to teardown
        - name: numberOfApprovalsRequired
          value: '1'
        - name: timeout
          value: '336h'

    # Create ConfigMap with istio-ingressgateway LoadBalancer IP (after ELM/EIC/iFlow deployment)
    - name: validate-and-create-configmap
      runAfter: [approval-elm-eic-iflow-deployed]
      taskRef: { name: rosa-validate-and-create-configmap }
      params:
        - name: clusterName
          value: $(params.clusterName)
        - name: awsRegion
          value: $(params.awsRegion)
        - name: awsSecretName
          value: $(params.awsSecretName)
        - name: redhatTokenSecretName
          value: $(params.redhatTokenSecretName)
      workspaces:
        - name: source
          workspace: source

    # Endpoint tests run after ConfigMap creation
    - name: test-httpbinipfilter
      runAfter: [validate-and-create-configmap]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /httpbinipfilter
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-http-test1
      runAfter: [validate-and-create-configmap]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /http/test1
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-http-testelster
      runAfter: [validate-and-create-configmap]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /http/testelster
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-slvredis
      runAfter: [validate-and-create-configmap]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /slvredis
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-ratelimit-slvredis
      runAfter: [test-slvredis]
      taskRef: { name: rate-limit-test }
      params:
        - name: endpointPath
          value: /slvredis
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    # Manual approval before second round of tests
    - name: approval-second-test-round
      runAfter:
        - test-httpbinipfilter
        - test-http-test1
        - test-http-testelster
        - test-slvredis
        - test-ratelimit-slvredis
      taskRef:
        apiVersion: openshift-pipelines.org/v1alpha1
        kind: ApprovalTask
      params:
        - name: approvers
          value:
            - mjiao
            - rbhandar
            - ksatarin
            - kubeadmin
            - kube:admin
            - system:admin
        - name: description
          value: |
            First round of endpoint tests completed successfully.

            Cluster: $(params.clusterName)

            ‚úÖ APPROVE: Run second round of endpoint tests
            ‚ùå REJECT: Skip second round and proceed
        - name: numberOfApprovalsRequired
          value: '1'
        - name: timeout
          value: '336h'

    # Second round of endpoint tests
    - name: test-httpbinipfilter-round2
      runAfter: [approval-second-test-round]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /httpbinipfilter
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-http-test1-round2
      runAfter: [approval-second-test-round]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /http/test1
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-http-testelster-round2
      runAfter: [approval-second-test-round]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /http/testelster
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-slvredis-round2
      runAfter: [approval-second-test-round]
      taskRef: { name: endpoint-tests }
      params:
        - name: endpointPath
          value: /slvredis
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: test-ratelimit-slvredis-round2
      runAfter: [test-slvredis-round2]
      taskRef: { name: rate-limit-test }
      params:
        - name: endpointPath
          value: /slvredis
        - name: clusterConfigMapName
          value: "cluster-info-rosa-$(params.clusterName)"
        - name: eicAuthSecretName
          value: $(params.eicAuthSecretName)
        - name: publicDNS
          value: $(params.publicDNS)
      workspaces:
        - name: source
          workspace: source

    - name: update-jira-ticket
      runAfter:
        - test-httpbinipfilter-round2
        - test-http-test1-round2
        - test-http-testelster-round2
        - test-slvredis-round2
        - test-ratelimit-slvredis-round2
      taskRef:
        name: jira-add-comment-custom
      params:
        - name: jiraSecretName
          value: $(params.jiraSecretName)
        - name: jiraIssueKey
          value: $(params.jiraIssueKey)
        - name: comment
          value: |
            h2. ‚úÖ Complete EIC Validation Pipeline Completed (ROSA)

            ROSA HCP cluster with full EIC infrastructure and all automated endpoint tests completed successfully.

            *Infrastructure Configuration:*
            * *Cluster Name:* $(params.clusterName)
            * *AWS Region:* $(params.awsRegion)
            * *ROSA Version:* $(params.rosaVersion)
            * *RDS PostgreSQL:* $(params.deployPostgres) (VPC private, Terraform-managed)
            * *ElastiCache Redis:* $(params.deployRedis) (VPC private, Terraform-managed)
            * *S3 for Quay:* $(params.deployQuay) (Encrypted, Terraform-managed)
            * *Quay Registry:* ‚úÖ Deployed

            *Pipeline Status:*
            * Repository cloned: ‚úÖ
            * ROSA deployment with AWS services: ‚úÖ Completed
            * Quay registry deployment: ‚úÖ Completed
            * Validation and access setup: ‚úÖ Completed
            * Endpoint tests (2 rounds): ‚úÖ All Passed

            *Pipeline Details:*
            * *Repository:* $(params.repoUrl)
            * *Revision:* $(params.revision)
            * *Public DNS:* $(params.publicDNS)

            *Executed Tests (Round 1):*
            * test-httpbinipfilter ‚úÖ
            * test-http-test1 ‚úÖ
            * test-http-testelster ‚úÖ
            * test-slvredis ‚úÖ
            * test-ratelimit-slvredis ‚úÖ

            *Executed Tests (Round 2):*
            * test-httpbinipfilter-round2 ‚úÖ
            * test-http-test1-round2 ‚úÖ
            * test-http-testelster-round2 ‚úÖ
            * test-slvredis-round2 ‚úÖ
            * test-ratelimit-slvredis-round2 ‚úÖ

            *Infrastructure Components:*
            * ROSA HCP OpenShift cluster ‚úÖ
            * AWS RDS PostgreSQL (VPC private) ‚úÖ
            * AWS ElastiCache Redis (VPC private) ‚úÖ
            * S3 bucket for Quay registry ‚úÖ
            * All EIC endpoints validated ‚úÖ

            *Security:*
            * RDS PostgreSQL: Private connectivity via VPC security groups (Terraform-managed)
            * ElastiCache Redis: Private access within VPC (Terraform-managed)
            * S3 Storage: Encrypted with IAM user permissions (Terraform-managed)
            * Quay: Certificate trust configured for OpenShift integration

            Ready for manual teardown approval. The complete EIC infrastructure will be destroyed once approved.

    # Manual approval step before teardown - this will pause the pipeline
    - name: approval-teardown
      runAfter:
        - update-jira-ticket
      taskRef:
        apiVersion: openshift-pipelines.org/v1alpha1
        kind: ApprovalTask
      params:
        - name: approvers
          value:
            - mjiao
            - rbhandar
            - ksatarin
            - kubeadmin
            - kube:admin
            - system:admin
        - name: description
          value: |
            All endpoint tests completed. Please review results.

            ‚úÖ APPROVE: Tear down ROSA cluster and AWS resources
            ‚ùå REJECT: Keep cluster running (will timeout after 336h and teardown anyway)
        - name: numberOfApprovalsRequired
          value: '1'
        - name: timeout
          value: '336h'

    # Teardown after approval
    - name: teardown-rosa
      runAfter: [approval-teardown]
      taskRef: { name: rosa-teardown }
      params:
        - name: clusterName
          value: $(params.clusterName)
        - name: awsRegion
          value: $(params.awsRegion)
        - name: awsSecretName
          value: $(params.awsSecretName)
        - name: redhatTokenSecretName
          value: $(params.redhatTokenSecretName)
        - name: terraformStateS3Bucket
          value: $(params.terraformStateS3Bucket)
        - name: terraformStateDynamoDBTable
          value: $(params.terraformStateDynamoDBTable)
      workspaces:
        - name: source
          workspace: source
