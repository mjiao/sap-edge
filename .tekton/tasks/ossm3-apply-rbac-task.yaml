# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: ossm3-apply-rbac
spec:
  description: >-
    Apply RBAC permissions for SAP Edge Lifecycle Management restricted-access
    model. Applies CRDs, ClusterRoles, ClusterRoleBindings, an optional
    admission webhook, and namespace-specific Roles and RoleBindings from
    YAML files provided via a ConfigMap workspace.
  params:
    - name: hostedClusterName
      type: string
      description: "Name of the hosted cluster"
    - name: hostedClusterNamespace
      type: string
      description: "Namespace for HostedCluster resources"
      default: "clusters"
    - name: hubKubeconfigSecretName
      type: string
      description: "Name of the Secret containing kubeconfig for hub cluster (optional, uses in-cluster config if empty)"
      default: ""
    - name: skipWebhook
      type: string
      description: "Skip optional admission webhook installation"
      default: "false"
  workspaces:
    - name: source
    - name: rbac-resources
      description: "Workspace containing RBAC YAML files from SAP Note 3618713 resources.zip"
  steps:
    - name: apply-rbac
      image: registry.access.redhat.com/ubi9/ubi
      timeout: "336h"
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        CLUSTER_NAME="$(params.hostedClusterName)"
        CLUSTER_NS="$(params.hostedClusterNamespace)"
        HUB_KUBECONFIG_SECRET="$(params.hubKubeconfigSecretName)"
        SKIP_WEBHOOK="$(params.skipWebhook)"
        RBAC_DIR="$(workspaces.rbac-resources.path)"

        echo "=========================================="
        echo "OSSM3 Apply RBAC Task"
        echo "=========================================="
        echo "Hosted Cluster: ${CLUSTER_NAME}"
        echo "Cluster Namespace: ${CLUSTER_NS}"
        echo "RBAC Resources Directory: ${RBAC_DIR}"
        echo "Skip Webhook: ${SKIP_WEBHOOK}"
        echo "=========================================="

        # Install required tools
        echo "üì¶ Installing OpenShift CLI..."
        curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz
        tar xzf /tmp/oc.tar.gz -C /tmp
        mv /tmp/oc /usr/local/bin/
        cp /usr/local/bin/oc /usr/local/bin/kubectl
        rm -f /tmp/oc.tar.gz
        oc version --client

        # Configure hub cluster kubeconfig if provided
        if [[ -n "${HUB_KUBECONFIG_SECRET}" ]]; then
          echo "üîê Extracting hub cluster kubeconfig from secret: ${HUB_KUBECONFIG_SECRET}..."
          HUB_KUBECONFIG="/tmp/hub-kubeconfig"
          if kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.kubeconfig}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "‚úÖ Kubeconfig extracted (key: kubeconfig)"
          elif kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.config}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "‚úÖ Kubeconfig extracted (key: config)"
          elif kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.value}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "‚úÖ Kubeconfig extracted (key: value)"
          else
            echo "‚ùå Failed to extract kubeconfig from secret '${HUB_KUBECONFIG_SECRET}'"
            echo "   Secret should have kubeconfig data under key 'kubeconfig', 'config', or 'value'"
            exit 1
          fi
          chmod 600 "${HUB_KUBECONFIG}"
          export KUBECONFIG="${HUB_KUBECONFIG}"
          echo "‚úÖ Using hub kubeconfig for cluster operations"
          oc whoami
        else
          echo "‚ÑπÔ∏è  No hub kubeconfig secret provided, using in-cluster service account"
        fi

        # Extract kubeconfig for hosted cluster
        echo "üîê Extracting kubeconfig for hosted cluster..."
        KUBECONFIG_SECRET="${CLUSTER_NAME}-admin-kubeconfig"

        if ! oc get secret "${KUBECONFIG_SECRET}" -n "${CLUSTER_NS}" > /dev/null 2>&1; then
          echo "‚ùå Kubeconfig secret '${KUBECONFIG_SECRET}' not found in namespace '${CLUSTER_NS}'"
          exit 1
        fi

        HOSTED_KUBECONFIG="/tmp/hosted-kubeconfig"
        oc get secret "${KUBECONFIG_SECRET}" -n "${CLUSTER_NS}" \
          -o jsonpath='{.data.kubeconfig}' | base64 -d > "${HOSTED_KUBECONFIG}"
        chmod 600 "${HOSTED_KUBECONFIG}"

        export KUBECONFIG="${HOSTED_KUBECONFIG}"

        echo "üîç Verifying access to hosted cluster..."
        oc get nodes
        echo "‚úÖ Successfully connected to hosted cluster"

        # Verify RBAC resources directory has YAML files
        echo ""
        echo "üîç Checking RBAC resources directory..."
        ls "${RBAC_DIR}"/*.yaml 2>/dev/null || true
        YAML_COUNT=$(find "${RBAC_DIR}" -name "*.yaml" -type f 2>/dev/null | wc -l | tr -d ' ')
        if [[ "${YAML_COUNT}" -eq 0 ]]; then
          echo "‚ùå No YAML files found in RBAC resources directory: ${RBAC_DIR}"
          echo "   Ensure the ConfigMap was created from the extracted resources.zip"
          exit 1
        fi
        echo "‚úÖ Found ${YAML_COUNT} YAML files in RBAC resources directory"

        # Helper function to apply a file if it exists
        apply_if_exists() {
          local file="$1"
          local namespace="${2:-}"
          if [[ -f "${file}" ]]; then
            if [[ -n "${namespace}" ]]; then
              echo "   Applying $(basename "${file}") in namespace ${namespace}"
              oc apply -f "${file}" -n "${namespace}"
            else
              echo "   Applying $(basename "${file}") (cluster-scoped)"
              oc apply -f "${file}"
            fi
          else
            echo "   ‚ö†Ô∏è File not found: $(basename "${file}") - skipping"
          fi
        }

        # --- Step 4.1: Apply Custom Resource Definitions (CRDs) first ---
        echo ""
        echo "üì¶ Applying Custom Resource Definitions (CRDs)..."
        for CRD_FILE in "${RBAC_DIR}"/crd-*.yaml; do
          if [[ -f "${CRD_FILE}" ]]; then
            apply_if_exists "${CRD_FILE}"
          fi
        done
        echo "‚úÖ CRDs applied"

        # --- Step 4.2: Apply ClusterRoles ---
        echo ""
        echo "üì¶ Applying ClusterRoles..."
        for CR_FILE in "${RBAC_DIR}"/cr-*.yaml; do
          if [[ -f "${CR_FILE}" ]]; then
            apply_if_exists "${CR_FILE}"
          fi
        done
        echo "‚úÖ ClusterRoles applied"

        # --- Apply ClusterRoleBindings ---
        echo "üì¶ Applying ClusterRoleBindings..."
        for CRB_FILE in "${RBAC_DIR}"/crb-*.yaml; do
          if [[ -f "${CRB_FILE}" ]]; then
            apply_if_exists "${CRB_FILE}"
          fi
        done
        echo "‚úÖ ClusterRoleBindings applied"

        # --- Step 4.3: Apply admission webhook (optional) ---
        if [[ "${SKIP_WEBHOOK}" != "true" ]]; then
          echo ""
          echo "üì¶ Applying admission webhook..."
          for WH_FILE in "${RBAC_DIR}"/webhook-*.yaml; do
            if [[ -f "${WH_FILE}" ]]; then
              apply_if_exists "${WH_FILE}"
            fi
          done
          echo "‚úÖ Admission webhook applied"
        else
          echo ""
          echo "‚è≠Ô∏è Skipping admission webhook installation (skipWebhook=true)"
        fi

        # --- Namespace-Specific Permissions ---
        echo ""
        echo "üì¶ Applying namespace-specific permissions..."

        # --- Permissions for 'edgelm' namespace ---
        echo ""
        echo "üîß Namespace: edgelm"
        apply_if_exists "${RBAC_DIR}/role-edgelm-manage.yaml" "edgelm"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-manage.yaml" "edgelm"
        apply_if_exists "${RBAC_DIR}/role-edgelm-admin.yaml" "edgelm"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-admin.yaml" "edgelm"

        # --- Permissions for 'istio-gateways' namespace ---
        echo ""
        echo "üîß Namespace: istio-gateways"
        apply_if_exists "${RBAC_DIR}/role-edgelm-manage.yaml" "istio-gateways"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-manage.yaml" "istio-gateways"
        apply_if_exists "${RBAC_DIR}/role-istio-gateways-admin.yaml" "istio-gateways"
        apply_if_exists "${RBAC_DIR}/rb-istio-gateways-admin.yaml" "istio-gateways"

        # --- Permissions for 'edge-icell' namespace ---
        echo ""
        echo "üîß Namespace: edge-icell"
        apply_if_exists "${RBAC_DIR}/role-edgelm-manage.yaml" "edge-icell"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-manage.yaml" "edge-icell"
        apply_if_exists "${RBAC_DIR}/role-edge-icell.yaml" "edge-icell"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell.yaml" "edge-icell"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell-admin.yaml" "edge-icell"

        # --- Permissions for 'edge-icell-ela' namespace ---
        echo ""
        echo "üîß Namespace: edge-icell-ela"
        apply_if_exists "${RBAC_DIR}/role-edgelm-manage.yaml" "edge-icell-ela"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-manage.yaml" "edge-icell-ela"
        apply_if_exists "${RBAC_DIR}/role-edge-icell-ela.yaml" "edge-icell-ela"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell-ela.yaml" "edge-icell-ela"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell-ela-admin.yaml" "edge-icell-ela"

        # --- Permissions for 'edge-icell-secrets' namespace ---
        echo ""
        echo "üîß Namespace: edge-icell-secrets"
        apply_if_exists "${RBAC_DIR}/role-edgelm-manage.yaml" "edge-icell-secrets"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-manage.yaml" "edge-icell-secrets"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell-secrets-admin.yaml" "edge-icell-secrets"

        # --- Permissions for 'edge-icell-services' namespace ---
        echo ""
        echo "üîß Namespace: edge-icell-services"
        apply_if_exists "${RBAC_DIR}/role-edgelm-manage.yaml" "edge-icell-services"
        apply_if_exists "${RBAC_DIR}/rb-edgelm-manage.yaml" "edge-icell-services"
        apply_if_exists "${RBAC_DIR}/role-edge-icell-services.yaml" "edge-icell-services"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell-services.yaml" "edge-icell-services"
        apply_if_exists "${RBAC_DIR}/rb-edge-icell-services-admin.yaml" "edge-icell-services"

        echo ""
        echo "=========================================="
        echo "‚úÖ RBAC permissions applied successfully"
        echo "=========================================="
