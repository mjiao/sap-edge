# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: aro-deployment-status-report
spec:
  description: Validate pods and generate deployment status report for ARO cluster
  params:
    - name: aroClusterName
      type: string
      description: "ARO cluster name"
    - name: azureSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Azure service principal credentials"
    - name: namespace
      type: string
      description: "Namespace to check pod status"
      default: "edgelm"
    - name: expectedPodCount
      type: string
      description: "Expected minimum number of pods (0 to skip validation)"
      default: "0"
    - name: deploymentType
      type: string
      description: "Type of deployment (e.g., aro-quay-complete)"
      default: "aro-quay-complete"
  workspaces:
    - name: source
  steps:
    - name: validate-and-report
      image: registry.access.redhat.com/ubi9/ubi
      workingDir: $(workspaces.source.path)
      env:
        - name: CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: $(params.azureSecretName)
              key: CLIENT_ID
        - name: CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: $(params.azureSecretName)
              key: CLIENT_SECRET
        - name: TENANT_ID
          valueFrom:
            secretKeyRef:
              name: $(params.azureSecretName)
              key: TENANT_ID
        - name: ARO_RESOURCE_GROUP
          valueFrom:
            secretKeyRef:
              name: $(params.azureSecretName)
              key: ARO_RESOURCE_GROUP
        - name: ARO_CLUSTER_NAME
          value: $(params.aroClusterName)
        - name: NAMESPACE
          value: "$(params.namespace)"
        - name: EXPECTED_POD_COUNT
          value: "$(params.expectedPodCount)"
        - name: DEPLOYMENT_TYPE
          value: $(params.deploymentType)
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "ðŸ“Š ARO Deployment Status Report for cluster: ${ARO_CLUSTER_NAME}"
        echo "=============================================="

        # Install required tools
        echo "ðŸ“¦ Installing required tools..."
        dnf install -y make libicu jq tar gzip

        # Install Azure CLI
        echo "ðŸ“¦ Installing Azure CLI..."
        rpm --import https://packages.microsoft.com/keys/microsoft.asc
        dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
        dnf clean all
        dnf install -y azure-cli-2.59.0

        # Install OpenShift CLI
        echo "ðŸ“¦ Installing OpenShift CLI..."
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz | tar xz
        mv oc kubectl /usr/local/bin/

        # Login to Azure
        echo "ðŸ” Logging into Azure..."
        make azure-login

        # Get ARO credentials and login to cluster
        echo "ðŸ” Getting ARO credentials..."
        rm -f kubeconfig kubeconfig.backup
        az aro get-admin-kubeconfig --name "${ARO_CLUSTER_NAME}" --resource-group "${ARO_RESOURCE_GROUP}" --file kubeconfig
        cp kubeconfig kubeconfig.backup
        sed '/^    server:/a\    insecure-skip-tls-verify: true' kubeconfig.backup > kubeconfig
        export KUBECONFIG="$(pwd)/kubeconfig"

        # Get cluster info
        echo ""
        echo "ðŸ”´ ARO Cluster Status:"
        echo "  Cluster Name: ${ARO_CLUSTER_NAME}"
        echo "  Resource Group: ${ARO_RESOURCE_GROUP}"
        API_URL=$(az aro show --name "${ARO_CLUSTER_NAME}" --resource-group "${ARO_RESOURCE_GROUP}" --query "apiserverProfile.url" -o tsv 2>/dev/null || echo "N/A")
        CONSOLE_URL=$(az aro show --name "${ARO_CLUSTER_NAME}" --resource-group "${ARO_RESOURCE_GROUP}" --query "consoleProfile.url" -o tsv 2>/dev/null || echo "N/A")
        echo "  API URL: ${API_URL}"
        echo "  Console URL: ${CONSOLE_URL}"
        echo ""

        echo "ðŸ–¥ï¸ Node Status:"
        oc get nodes -o wide
        echo ""

        # Namespace pod validation
        echo "ðŸ” Checking namespace '${NAMESPACE}'..."
        POD_VALIDATION_STATUS="SKIPPED"

        if [ "${EXPECTED_POD_COUNT}" -gt 0 ]; then
          if ! oc get namespace "${NAMESPACE}" >/dev/null 2>&1; then
            echo "âŒ Namespace '${NAMESPACE}' does not exist"
            POD_VALIDATION_STATUS="FAILED"
          else
            echo "âœ… Namespace '${NAMESPACE}' exists"

            # Get pod info
            PODS_INFO=$(oc get pods -n "${NAMESPACE}" -o json 2>/dev/null || echo '{"items":[]}')
            TOTAL_PODS=$(echo "$PODS_INFO" | jq -r '.items | length')
            RUNNING_PODS=$(echo "$PODS_INFO" | jq -r '[.items[] | select(.status.phase == "Running")] | length')
            COMPLETED_PODS=$(echo "$PODS_INFO" | jq -r '[.items[] | select(.status.phase == "Succeeded")] | length')
            FAILED_PODS=$(echo "$PODS_INFO" | jq -r '[.items[] | select(.status.phase == "Failed")] | length')

            echo "  Total pods: ${TOTAL_PODS} (expected minimum: ${EXPECTED_POD_COUNT})"
            echo "  Running: ${RUNNING_PODS}"
            echo "  Completed: ${COMPLETED_PODS}"
            echo "  Failed: ${FAILED_PODS}"
            echo ""
            oc get pods -n "${NAMESPACE}" -o wide
            echo ""

            ACCEPTABLE_PODS=$((RUNNING_PODS + COMPLETED_PODS))
            if [ "${ACCEPTABLE_PODS}" -ge "${EXPECTED_POD_COUNT}" ] && [ "${FAILED_PODS}" -eq 0 ]; then
              echo "âœ… Pod validation passed: ${ACCEPTABLE_PODS} pods in acceptable state"
              POD_VALIDATION_STATUS="PASSED"
            else
              echo "âŒ Pod validation failed: expected ${EXPECTED_POD_COUNT}, got ${ACCEPTABLE_PODS} acceptable (${FAILED_PODS} failed)"
              POD_VALIDATION_STATUS="FAILED"
            fi
          fi
        else
          echo "â„¹ï¸ Pod validation skipped (expectedPodCount=0)"
          if oc get namespace "${NAMESPACE}" >/dev/null 2>&1; then
            oc get pods -n "${NAMESPACE}" -o wide 2>/dev/null || echo "  No pods found"
          fi
        fi
        echo ""

        # Key namespaces
        echo "ðŸ“ Key Namespaces:"
        oc get namespaces | grep -E 'edgelm|quay|openshift-operators' || echo "  No matching namespaces found"
        echo ""

        # Generate status file
        cat > final-deployment-status.json << EOF
        {
          "platform": "aro",
          "deployment_type": "${DEPLOYMENT_TYPE}",
          "cluster_name": "${ARO_CLUSTER_NAME}",
          "resource_group": "${ARO_RESOURCE_GROUP}",
          "api_url": "${API_URL}",
          "console_url": "${CONSOLE_URL}",
          "namespace_validated": "${NAMESPACE}",
          "pod_validation_status": "${POD_VALIDATION_STATUS}",
          "completion_timestamp": "$(date -Iseconds)",
          "status": "$([ "${POD_VALIDATION_STATUS}" = "FAILED" ] && echo "FAILED" || echo "SUCCESS")"
        }
EOF

        echo "ðŸ“Š Deployment Summary:"
        echo "  Platform: ARO"
        echo "  Deployment Type: ${DEPLOYMENT_TYPE}"
        echo "  Cluster: ${ARO_CLUSTER_NAME}"
        echo "  Pod Validation: ${POD_VALIDATION_STATUS}"
        echo "  Timestamp: $(date -Iseconds)"
        echo ""

        # Exit based on validation result
        if [ "${POD_VALIDATION_STATUS}" = "FAILED" ]; then
          echo "âŒ Deployment validation FAILED"
          exit 1
        fi

        echo "âœ… Deployment status report completed successfully!"
