# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: jira-add-comment-custom
spec:
  description: >-
    This task adds a comment to a Jira issue using the official Jira REST API with curl.
  params:
    - name: jiraSecretName
      type: string
      description: The name of the Kubernetes Secret holding Jira credentials.
    - name: jiraIssueKey
      type: string
      description: The issue key to comment on (e.g., PROJ-123).
    - name: comment
      type: string
      description: The text content of the comment to add.
  steps:
    - name: post-comment
      image: registry.access.redhat.com/ubi9/ubi-minimal
      env:
        - name: JIRA_HOST
          valueFrom:
            secretKeyRef:
              name: $(params.jiraSecretName)
              key: serverURL
        - name: JIRA_USERNAME
          valueFrom:
            secretKeyRef:
              name: $(params.jiraSecretName)
              key: username
        - name: JIRA_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.jiraSecretName)
              key: apiToken
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        # --- 1. Install jq for robust JSON handling ---
        echo "Installing jq..."
        microdnf install -y jq > /dev/null

        # --- 2. Prepare Authentication Header ---
        BASIC_AUTH=$(echo -n "$JIRA_USERNAME:$JIRA_API_TOKEN" | base64)
        AUTH_HEADER="Authorization: Basic $BASIC_AUTH"

        # --- 3. Construct the JSON Payload (for API v2) ---
        JSON_PAYLOAD=$(jq -n --arg comment_text "$(params.comment)" '{body: $comment_text}')

        # --- 4. Define the API URL (for API v2) ---
        API_URL="$JIRA_HOST/rest/api/2/issue/$(params.jiraIssueKey)/comment"

        echo "Jira API Endpoint: $API_URL"
        echo "Payload: $JSON_PAYLOAD"

        # --- 5. Make the API Call using curl ---
        curl --http1.1 \
             --request POST \
             --header "$AUTH_HEADER" \
             --header "Content-Type: application/json" \
             --header "Accept: application/json" \
             --url "$API_URL" \
             --data "$JSON_PAYLOAD" \
             --fail --show-error --silent

        echo "âœ… Successfully added comment to Jira issue $(params.jiraIssueKey)."