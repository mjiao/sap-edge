# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: jira-add-comment-custom
spec:
  description: >-
    This task adds a comment to a Jira issue using the official Jira REST API with curl.
    It checks for duplicate success messages by examining the last comment and skips
    posting if a similar success message already exists.
  params:
    - name: jiraSecretName
      type: string
      description: The name of the Kubernetes Secret holding Jira credentials.
    - name: jiraIssueKey
      type: string
      description: The issue key to comment on (e.g., PROJ-123).
    - name: comment
      type: string
      description: The text content of the comment to add.
  steps:
    - name: post-comment
      image: registry.access.redhat.com/ubi9/ubi-minimal
      env:
        - name: JIRA_HOST
          valueFrom:
            secretKeyRef:
              name: $(params.jiraSecretName)
              key: serverURL
        - name: JIRA_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.jiraSecretName)
              key: apiToken
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        echo "Installing jq..."
        microdnf install -y jq > /dev/null

        AUTH_HEADER="Authorization: Bearer $JIRA_API_TOKEN"
        
        # Check for duplicate success messages
        echo "üîç Checking for duplicate success messages..."
        
        # Get the issue comments
        COMMENTS_URL="$JIRA_HOST/rest/api/2/issue/$(params.jiraIssueKey)/comment"
        COMMENTS_JSON=$(curl --silent \
                             --header "$AUTH_HEADER" \
                             --header "Content-Type: application/json" \
                             --url "$COMMENTS_URL")
        
        # Extract the last comment body
        LAST_COMMENT=$(echo "$COMMENTS_JSON" | jq -r '.comments[-1].body // ""')
        
        # Check if comment contains success markers
        COMMENT_TEXT="$(params.comment)"
        
        # Define success markers to check
        SUCCESS_MARKERS=(
          "‚úÖ Complete EIC Validation Pipeline Completed"
          "‚úÖ ROSA Edge LM Validation Pipeline Completed"
          "Pipeline Status:"
          "All endpoint tests completed"
          "Edge LM validation completed"
        )
        
        # Check if the last comment contains any success marker
        IS_DUPLICATE=false
        for MARKER in "${SUCCESS_MARKERS[@]}"; do
          if echo "$LAST_COMMENT" | grep -q "$MARKER"; then
            # Also check if the new comment contains the same marker
            if echo "$COMMENT_TEXT" | grep -q "$MARKER"; then
              echo "‚ö†Ô∏è  Last comment already contains success marker: '$MARKER'"
              IS_DUPLICATE=true
              break
            fi
          fi
        done
        
        if [ "$IS_DUPLICATE" = true ]; then
          echo "‚è≠Ô∏è  Skipping duplicate success message to Jira issue $(params.jiraIssueKey)"
          echo "üìã Last comment summary:"
          echo "$LAST_COMMENT" | head -5
          echo "..."
          echo ""
          echo "‚úÖ No duplicate comment added (success message already exists)"
          exit 0
        fi
        
        # Proceed with adding the comment
        echo "üìù Adding new comment to Jira issue $(params.jiraIssueKey)..."

        # Create the JSON payload for the "Edit Issue" endpoint
        JSON_PAYLOAD=$(jq -n --arg comment_text "$COMMENT_TEXT" \
          '{ "update": { "comment": [ { "add": { "body": $comment_text } } ] } }')

        # The URL points to the issue itself
        API_URL="$JIRA_HOST/rest/api/2/issue/$(params.jiraIssueKey)"

        echo "Jira API Endpoint: $API_URL"

        # Make the API Call using PUT and the Bearer token auth
        if curl --request PUT \
             --header "$AUTH_HEADER" \
             --header "Content-Type: application/json" \
             --url "$API_URL" \
             --data "$JSON_PAYLOAD" \
             --fail --show-error --silent; then
          echo "‚úÖ Successfully added comment to Jira issue $(params.jiraIssueKey)"
        else
          echo "‚ùå Failed to add comment to Jira issue $(params.jiraIssueKey)"
          exit 1
        fi