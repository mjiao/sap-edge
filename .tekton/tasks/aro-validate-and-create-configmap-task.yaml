# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: aro-validate-and-create-configmap
spec:
  description: >-
    Creates a ConfigMap with cluster info for endpoint tests (host, ingressIP from
    istio-ingressgateway LB). Must run AFTER EIC is deployed and MetalLB assigns the IP.
  params:
    - name: aroClusterName
      type: string
      description: "ARO cluster name"
    - name: azureSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Azure service principal credentials"
      default: "azure-sp-secret"
  workspaces:
    - name: source
  results:
    - name: cluster-summary
      description: "Brief cluster and services validation summary"
  steps:
    - name: validate-and-create-configmap
      image: registry.access.redhat.com/ubi9/ubi
      workingDir: $(workspaces.source.path)
      timeout: "336h"
      env:
        - name: ARO_CLUSTER_NAME
          value: "$(params.aroClusterName)"
      envFrom:
        - secretRef:
            name: $(params.azureSecretName)
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        echo "âœ… Creating endpoint test ConfigMap from istio-ingressgateway..."
        echo "=============================================="

        # Install required packages
        echo "ðŸ“¦ Installing required packages..."
        dnf install -y jq tar make > /dev/null 2>&1

        # Install Azure CLI
        echo "ðŸ“¦ Installing Azure CLI..."
        rpm --import https://packages.microsoft.com/keys/microsoft.asc
        dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm > /dev/null 2>&1
        dnf install -y azure-cli > /dev/null 2>&1

        # Install OpenShift CLI
        echo "ðŸ“¦ Installing OpenShift CLI..."
        curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz
        tar xzf /tmp/oc.tar.gz -C /tmp
        mv /tmp/oc /usr/local/bin/
        cp /usr/local/bin/oc /usr/local/bin/kubectl
        rm -f /tmp/oc.tar.gz
        oc version --client

        # Login to Azure
        echo "ðŸ” Logging into Azure..."
        make azure-login
        make azure-set-subscription

        # Get ARO credentials and login
        echo "ðŸ” Getting ARO credentials..."
        CLUSTER_URL=$(make --no-print-directory aro-cluster-url | tail -1)
        CREDENTIALS_RAW=$(make --no-print-directory aro-credentials)
        CREDENTIALS_JSON=$(echo "$CREDENTIALS_RAW" | grep -v "Variable is not defined" | grep -v "Not all required variables are defined" | grep -v "az aro list-credentials")
        USERNAME=$(echo "$CREDENTIALS_JSON" | jq -r '.kubeadminUsername')
        PASSWORD=$(echo "$CREDENTIALS_JSON" | jq -r '.kubeadminPassword')

        echo "ðŸ” Logging into ARO cluster..."
        oc login "$CLUSTER_URL" -u "$USERNAME" -p "$PASSWORD" --insecure-skip-tls-verify=true

        echo "ðŸ” Verifying access to ARO cluster..."
        oc get nodes
        echo "âœ… Successfully connected to ARO cluster"

        # Get ingress domain from OpenShift ingress controller
        echo "ðŸ“‹ Getting ingress domain..."
        INGRESS_DOMAIN=""

        # Try to get ingress domain from ingress controller
        if oc get ingresscontroller default -n openshift-ingress-operator -o json &>/dev/null; then
          INGRESS_DOMAIN=$(oc get ingresscontroller default -n openshift-ingress-operator \
            -o jsonpath='{.status.domain}' 2>/dev/null || echo "")
          echo "Ingress Domain: ${INGRESS_DOMAIN}"
        fi

        # Fallback: Get from DNS config
        if [[ -z "${INGRESS_DOMAIN}" ]]; then
          INGRESS_DOMAIN=$(oc get dns cluster -o jsonpath='{.spec.baseDomain}' 2>/dev/null || echo "")
          if [[ -n "${INGRESS_DOMAIN}" ]]; then
            INGRESS_DOMAIN="apps.${INGRESS_DOMAIN}"
          fi
          echo "Ingress Domain (from DNS): ${INGRESS_DOMAIN}"
        fi

        # Get LoadBalancer IP from istio-ingressgateway service
        # This is populated by MetalLB after EIC application is deployed
        echo ""
        echo "ðŸ“‹ Getting LoadBalancer IP from istio-ingressgateway..."
        INGRESS_IP=""

        # Try istio-system namespace first
        if oc get svc istio-ingressgateway -n istio-system &>/dev/null; then
          echo "Found istio-ingressgateway in istio-system namespace"
          INGRESS_IP=$(oc get svc istio-ingressgateway -n istio-system \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

          if [[ -z "${INGRESS_IP}" ]]; then
            # Try hostname instead (for cloud providers)
            INGRESS_IP=$(oc get svc istio-ingressgateway -n istio-system \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          fi
        fi

        # Try istio-gateways namespace if not found
        if [[ -z "${INGRESS_IP}" ]] && oc get svc istio-ingressgateway -n istio-gateways &>/dev/null; then
          echo "Found istio-ingressgateway in istio-gateways namespace"
          INGRESS_IP=$(oc get svc istio-ingressgateway -n istio-gateways \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

          if [[ -z "${INGRESS_IP}" ]]; then
            INGRESS_IP=$(oc get svc istio-ingressgateway -n istio-gateways \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          fi
        fi

        # Fallback: try any service named istio-ingressgateway
        if [[ -z "${INGRESS_IP}" ]]; then
          echo "Searching for istio-ingressgateway in all namespaces..."
          ISTIO_SVC=$(oc get svc --all-namespaces -o json | jq -r '.items[] | select(.metadata.name=="istio-ingressgateway") | "\(.metadata.namespace)"' | head -1)
          if [[ -n "${ISTIO_SVC}" ]]; then
            echo "Found istio-ingressgateway in ${ISTIO_SVC} namespace"
            INGRESS_IP=$(oc get svc istio-ingressgateway -n "${ISTIO_SVC}" \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [[ -z "${INGRESS_IP}" ]]; then
              INGRESS_IP=$(oc get svc istio-ingressgateway -n "${ISTIO_SVC}" \
                -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
            fi
          fi
        fi

        if [[ -z "${INGRESS_IP}" ]]; then
          echo "âš ï¸ WARNING: Could not get LoadBalancer IP from istio-ingressgateway"
          echo "   Make sure EIC is deployed and MetalLB has assigned an IP"
          oc get svc --all-namespaces | grep -i istio || echo "No istio services found"
        else
          echo "âœ… LoadBalancer IP: ${INGRESS_IP}"
        fi

        echo ""
        echo "ðŸ“Š Ingress Configuration:"
        echo "  Domain: ${INGRESS_DOMAIN:-'Not determined'}"
        echo "  LoadBalancer IP: ${INGRESS_IP:-'Not determined'}"

        # Build the EIC host URL
        EIC_HOST=""
        if [[ -n "${INGRESS_DOMAIN}" ]]; then
          # Standard EIC pattern: eic.{ingress-domain}
          EIC_HOST="eic.${INGRESS_DOMAIN}"
        fi

        echo "  EIC Host: ${EIC_HOST:-'Not configured'}"

        # Create ConfigMap for endpoint tests
        CONFIGMAP_NAME="cluster-info-aro-${ARO_CLUSTER_NAME}"
        echo ""
        echo "ðŸ“ Creating ConfigMap '${CONFIGMAP_NAME}' for endpoint tests..."

        # Delete existing ConfigMap if present
        oc delete configmap "${CONFIGMAP_NAME}" --ignore-not-found=true

        # Create the ConfigMap (matching expected format: host + ingressIP only)
        oc create configmap "${CONFIGMAP_NAME}" \
          --from-literal=host="${EIC_HOST:-eic.apps.${ARO_CLUSTER_NAME}.local}" \
          --from-literal=ingressIP="${INGRESS_IP:-127.0.0.1}"

        echo "âœ… ConfigMap created successfully"
        oc get configmap "${CONFIGMAP_NAME}" -o yaml

        # Generate summary
        SUMMARY="ARO Cluster: ${ARO_CLUSTER_NAME} | Domain: ${INGRESS_DOMAIN:-N/A} | Ingress: ${INGRESS_IP:-N/A}"
        echo -n "${SUMMARY}" > $(results.cluster-summary.path)

        echo ""
        echo "âœ… ARO ConfigMap creation completed!"
        echo "ðŸ“‹ Summary:"
        echo "  Cluster: ${ARO_CLUSTER_NAME}"
        echo "  ConfigMap: ${CONFIGMAP_NAME}"
        echo "  EIC Host: ${EIC_HOST:-Not configured}"
        echo "  LoadBalancer IP (istio-ingressgateway): ${INGRESS_IP:-Not determined}"
