# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: hcp-deploy-postgres
spec:
  description: Deploy PostgreSQL on the hosted cluster using Crunchy Data Operator
  params:
    - name: hostedClusterName
      type: string
      description: "Name of the hosted cluster"
    - name: hostedClusterNamespace
      type: string
      description: "Namespace for HostedCluster resources"
      default: "clusters"
    - name: postgresNamespace
      type: string
      description: "Namespace for PostgreSQL deployment on hosted cluster"
      default: "sap-eic-external-postgres"
    - name: postgresVersion
      type: string
      description: "PostgreSQL version: v15, v16, v17"
      default: "v15"
    - name: skipWait
      type: string
      description: "Skip waiting for PostgreSQL readiness"
      default: "false"
    - name: hubKubeconfigSecretName
      type: string
      description: "Name of the Secret containing kubeconfig for hub cluster (optional, uses in-cluster config if empty)"
      default: ""
  workspaces:
    - name: source
  results:
    - name: postgres-host
      description: "PostgreSQL service host"
    - name: postgres-port
      description: "PostgreSQL service port"
    - name: postgres-database
      description: "PostgreSQL database name"
  steps:
    - name: deploy-postgres
      image: registry.access.redhat.com/ubi9/ubi
      timeout: "336h"
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        # Parameters
        CLUSTER_NAME="$(params.hostedClusterName)"
        CLUSTER_NS="$(params.hostedClusterNamespace)"
        PG_NAMESPACE="$(params.postgresNamespace)"
        PG_VERSION="$(params.postgresVersion)"
        SKIP_WAIT="$(params.skipWait)"
        HUB_KUBECONFIG_SECRET="$(params.hubKubeconfigSecretName)"

        echo "=========================================="
        echo "HCP Deploy PostgreSQL Task"
        echo "=========================================="
        echo "Hosted Cluster: ${CLUSTER_NAME}"
        echo "Cluster Namespace: ${CLUSTER_NS}"
        echo "PostgreSQL Namespace: ${PG_NAMESPACE}"
        echo "PostgreSQL Version: ${PG_VERSION}"
        echo "Skip Wait: ${SKIP_WAIT}"
        echo "=========================================="

        # Install required tools
        echo "ðŸ“¦ Installing required packages..."
        dnf install -y jq > /dev/null 2>&1

        echo "ðŸ“¦ Installing OpenShift CLI..."
        curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz
        tar xzf /tmp/oc.tar.gz -C /tmp
        mv /tmp/oc /usr/local/bin/
        cp /usr/local/bin/oc /usr/local/bin/kubectl
        rm -f /tmp/oc.tar.gz
        oc version --client

        # Configure hub cluster kubeconfig if provided
        if [[ -n "${HUB_KUBECONFIG_SECRET}" ]]; then
          echo "ðŸ” Extracting hub cluster kubeconfig from secret: ${HUB_KUBECONFIG_SECRET}..."
          HUB_KUBECONFIG="/tmp/hub-kubeconfig"
          # Try different common key names for kubeconfig in secrets
          if kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.kubeconfig}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "âœ… Kubeconfig extracted (key: kubeconfig)"
          elif kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.config}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "âœ… Kubeconfig extracted (key: config)"
          elif kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.value}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "âœ… Kubeconfig extracted (key: value)"
          else
            echo "âŒ Failed to extract kubeconfig from secret '${HUB_KUBECONFIG_SECRET}'"
            echo "   Secret should have kubeconfig data under key 'kubeconfig', 'config', or 'value'"
            exit 1
          fi
          chmod 600 "${HUB_KUBECONFIG}"
          export KUBECONFIG="${HUB_KUBECONFIG}"
          echo "âœ… Using hub kubeconfig for cluster operations"
          oc whoami
        else
          echo "â„¹ï¸  No hub kubeconfig secret provided, using in-cluster service account"
        fi

        # Extract kubeconfig for hosted cluster
        echo "ðŸ” Extracting kubeconfig for hosted cluster..."
        KUBECONFIG_SECRET="${CLUSTER_NAME}-admin-kubeconfig"

        if ! oc get secret "${KUBECONFIG_SECRET}" -n "${CLUSTER_NS}" > /dev/null 2>&1; then
          echo "âŒ Kubeconfig secret '${KUBECONFIG_SECRET}' not found in namespace '${CLUSTER_NS}'"
          exit 1
        fi

        HOSTED_KUBECONFIG="/tmp/hosted-kubeconfig"
        oc get secret "${KUBECONFIG_SECRET}" -n "${CLUSTER_NS}" \
          -o jsonpath='{.data.kubeconfig}' | base64 -d > "${HOSTED_KUBECONFIG}"
        chmod 600 "${HOSTED_KUBECONFIG}"

        # Set KUBECONFIG to hosted cluster
        export KUBECONFIG="${HOSTED_KUBECONFIG}"

        echo "ðŸ” Verifying access to hosted cluster..."
        oc get nodes
        echo "âœ… Successfully connected to hosted cluster"

        # Verify the deploy_postgres.sh script exists
        DEPLOY_SCRIPT="$(workspaces.source.path)/edge-integration-cell/deploy_postgres.sh"
        if [[ ! -f "${DEPLOY_SCRIPT}" ]]; then
          echo "âŒ Deploy script not found: ${DEPLOY_SCRIPT}"
          exit 1
        fi
        chmod +x "${DEPLOY_SCRIPT}"

        # Run the PostgreSQL deployment script
        echo ""
        echo "ðŸ˜ Deploying PostgreSQL on hosted cluster..."
        echo "----------------------------------------"

        cd "$(workspaces.source.path)/edge-integration-cell"

        DEPLOY_ARGS=("-n" "${PG_NAMESPACE}" "-v" "${PG_VERSION}" "-f")
        if [[ "${SKIP_WAIT}" == "true" ]]; then
          DEPLOY_ARGS+=("--skip-wait")
        fi

        bash deploy_postgres.sh "${DEPLOY_ARGS[@]}"

        echo "----------------------------------------"
        echo ""

        # Get PostgreSQL access details
        echo "ðŸ“‹ Getting PostgreSQL access details..."

        # Wait a moment for services to be created
        sleep 5

        # Get the primary service
        PG_SERVICE=$(oc get svc -n "${PG_NAMESPACE}" \
          -l postgres-operator.crunchydata.com/cluster=eic,postgres-operator.crunchydata.com/role=primary \
          -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "eic-primary")

        PG_HOST="${PG_SERVICE}.${PG_NAMESPACE}.svc.cluster.local"
        PG_PORT="5432"
        PG_DATABASE="eic"

        # Write results
        echo "${PG_HOST}" > $(results.postgres-host.path)
        echo "${PG_PORT}" > $(results.postgres-port.path)
        echo "${PG_DATABASE}" > $(results.postgres-database.path)

        # Display connection info
        echo ""
        echo "=========================================="
        echo "âœ… PostgreSQL deployed successfully!"
        echo "=========================================="
        echo "Host: ${PG_HOST}"
        echo "Port: ${PG_PORT}"
        echo "Database: ${PG_DATABASE}"
        echo "Namespace: ${PG_NAMESPACE}"
        echo ""
        echo "ðŸ“‹ PostgreSQL pods:"
        oc get pods -n "${PG_NAMESPACE}" -o wide
        echo ""
        echo "ðŸ“‹ PostgreSQL services:"
        oc get svc -n "${PG_NAMESPACE}"
        echo "=========================================="
