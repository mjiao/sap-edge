# SPDX-FileCopyrightText: 2024 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: rosa-quay-deploy
spec:
  description: |
    Deploy Quay registry on ROSA cluster with S3 storage and certificate trust.
    
    S3 bucket and credentials should be created by Terraform (rosa/terraform).
    Get values from Terraform outputs:
      - s3BucketName: terraform output -raw quay_s3_bucket_name
      - s3Region: terraform output -raw quay_s3_bucket_region
      - AWS credentials: terraform output -raw quay_s3_access_key_id / quay_s3_secret_access_key
  params:
    - name: clusterName
      type: string
      description: "ROSA cluster name (from Terraform output rosa_cluster_name)"
    - name: s3BucketName
      type: string
      description: "S3 bucket name for Quay storage (from Terraform output quay_s3_bucket_name)"
    - name: s3Region
      type: string
      description: "S3 region (from Terraform output quay_s3_bucket_region)"
      default: "us-east-1"
    - name: s3Host
      type: string
      description: "S3 host (default: s3.<region>.amazonaws.com)"
      default: "s3.amazonaws.com"
    - name: awsSecretName
      type: string
      description: "Name of the Kubernetes Secret containing AWS credentials"
      default: "aws-credentials-secret"
    - name: quayAdminPasswordSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Quay admin password and email"
      default: "quay-admin-secret"
    - name: redhatTokenSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Red Hat OCM token (for ROSA CLI authentication)"
      default: "redhat-token-secret"
  workspaces:
    - name: source
  steps:
    - name: deploy-rosa-quay
      image: registry.access.redhat.com/ubi9/ubi
      workingDir: $(workspaces.source.path)
      env:
        - name: CLUSTER_NAME
          value: $(params.clusterName)
        - name: S3_BUCKET_NAME
          value: $(params.s3BucketName)
        - name: S3_REGION
          value: $(params.s3Region)
        - name: S3_HOST
          value: $(params.s3Host)
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: $(params.awsSecretName)
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.awsSecretName)
              key: AWS_SECRET_ACCESS_KEY
        - name: QUAY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: $(params.quayAdminPasswordSecretName)
              key: password
        - name: QUAY_ADMIN_EMAIL
          valueFrom:
            secretKeyRef:
              name: $(params.quayAdminPasswordSecretName)
              key: email
        - name: REDHAT_OCM_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.redhatTokenSecretName)
              key: REDHAT_OCM_TOKEN
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "üöÄ Starting ROSA Quay registry deployment..."
        echo "============================================"
        echo "‚ÑπÔ∏è  Note: S3 bucket should be created by Terraform (rosa/terraform)"
        echo "   S3 credentials are retrieved from Terraform outputs and passed as parameters"
        echo ""
        echo "üîß Configuration:"
        echo "  Cluster Name: ${CLUSTER_NAME}"
        echo "  S3 Bucket: ${S3_BUCKET_NAME}"
        echo "  S3 Region: ${S3_REGION}"
        echo "  S3 Host: ${S3_HOST}"
        echo ""

        # Install required tools
        echo "üì¶ Installing required tools..."
        dnf install -y make libicu jq python3-pip wget unzip tar

        # Install OpenShift CLI
        echo "üì¶ Installing OpenShift CLI..."
        if ! command -v oc &> /dev/null; then
          wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          mkdir -p /tmp/oc-install
          tar xzf openshift-client-linux.tar.gz -C /tmp/oc-install
          mv /tmp/oc-install/oc /tmp/oc-install/kubectl /usr/local/bin/
          rm -rf /tmp/oc-install openshift-client-linux.tar.gz
        else
          echo "‚úÖ OpenShift CLI already installed"
        fi

        # Install ROSA CLI (needed for certificate trust configuration)
        echo "üì¶ Installing ROSA CLI..."
        if ! command -v rosa &> /dev/null; then
          rm -rf rosa rosa-linux.tar.gz  # Remove if exists from previous run
          wget -q https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz
          tar xzf rosa-linux.tar.gz
          mv rosa /usr/local/bin/
          rm -f rosa-linux.tar.gz
          rosa version
        else
          echo "‚úÖ ROSA CLI already installed"
          rosa version
        fi

        # Login to ROSA CLI
        echo "üîê Authenticating with Red Hat OCM..."
        if rosa login --token="${REDHAT_OCM_TOKEN}"; then
          echo "‚úÖ ROSA CLI authenticated successfully"
        else
          echo "‚ùå Failed to authenticate ROSA CLI"
          echo "‚ö†Ô∏è  Certificate trust configuration will not be available"
        fi

        # Install Ansible and required collections
        echo "üì¶ Installing Ansible and required collections..."
        pip3 install ansible kubernetes
        ansible-galaxy collection install -r ansible/requirements.yml

        # Verify tools are installed
        oc version --client

        # Set kubeconfig from previous task
        echo "üîê Setting up cluster authentication..."
        export KUBECONFIG="$(pwd)/kubeconfig"
        
        if [[ ! -f "${KUBECONFIG}" ]]; then
          echo "‚ùå kubeconfig file not found at: ${KUBECONFIG}"
          echo "‚ÑπÔ∏è  This should have been created by the validate-and-get-access task"
          exit 1
        fi
        echo "‚úÖ Found kubeconfig file"
        echo "üìç Kubeconfig path: ${KUBECONFIG}"

        # Verify we can access the cluster with the service account
        echo "üîç Verifying ROSA cluster access with cluster-admin-sa..."
        if ! oc whoami; then
          echo "‚ùå Cannot authenticate with kubeconfig"
          exit 1
        fi
        
        if oc get nodes 2>/dev/null; then
          echo "‚úÖ Cluster access confirmed"
          oc whoami
        else
          echo "‚ùå Cannot access cluster - authentication required"
          echo "üîç This is expected in pipeline environments where OAuth tokens are not available"
          echo "üí° For ROSA HCP clusters, manual authentication is required:"
          echo "   oc login https://api.${CLUSTER_NAME}.xxx.openshiftapps.com --username cluster-admin"
          echo ""
          echo "‚ö†Ô∏è  Skipping Quay deployment due to cluster access limitations"
          echo "‚ÑπÔ∏è  Quay can be deployed manually once cluster authentication is established"
          exit 0
        fi

        # Verify the service account has the necessary permissions
        echo "üîç Verifying service account permissions..."
        if oc auth can-i '*' '*' --all-namespaces; then
          echo "‚úÖ Service account has cluster-admin permissions"
        else
          echo "‚ö†Ô∏è  Service account may have limited permissions"
        fi

        # Step 1: Complete ROSA Quay deployment with S3 storage
        echo ""
        echo "Step 1/4: Deploying Quay registry with S3 storage..."
        echo "üìç Using KUBECONFIG: ${KUBECONFIG}"
        
        # Ensure KUBECONFIG is available to make/ansible
        if ! KUBECONFIG="${KUBECONFIG}" make rosa-quay-deploy-complete; then
            echo "‚ùå ROSA Quay deployment failed"
            echo "üìã Check the ansible playbook logs above for details"
            exit 1
        fi

        # Step 2: Wait for Quay to be ready
        echo ""
        echo "Step 2/4: Waiting for Quay registry to be ready..."
        make rosa-quay-wait-ready

        # Step 3: Wait for HTTP service to be ready
        echo ""
        echo "Step 3/4: Waiting for Quay HTTP service..."
        make rosa-quay-wait-http-ready

        # Step 4: Get final status and information
        echo ""
        echo "Step 4/4: Getting Quay registry information..."
        make rosa-quay-info

        echo "‚úÖ ROSA Quay registry deployment completed successfully!"

        # Save deployment info to workspace for next tasks
        cat > rosa-quay-deployment-info.txt << EOF
        S3_BUCKET_NAME=${S3_BUCKET_NAME}
        S3_REGION=${S3_REGION}
        S3_HOST=${S3_HOST}
        CLUSTER_NAME=${CLUSTER_NAME}
        QUAY_DEPLOYMENT_STATUS=SUCCESS
        EOF

        echo "üíæ Deployment information saved to rosa-quay-deployment-info.txt"

        # Configure certificate trust for ROSA HCP cluster
        echo ""
        echo "üîí Configuring Certificate Trust for ROSA HCP:"
        echo "=========================================="

        # Get Quay registry endpoint
        QUAY_ENDPOINT=$(oc get quayregistry test-registry -n openshift-operators -o jsonpath='{.status.registryEndpoint}' 2>/dev/null || echo "")
        
        if [[ -z "${QUAY_ENDPOINT}" ]]; then
          echo "‚ö†Ô∏è  Quay registry endpoint not available yet"
          echo "‚ÑπÔ∏è  Certificate trust will be configured once Quay route is ready"
        else
          echo "üì° Quay Registry Endpoint: ${QUAY_ENDPOINT}"
          
          # Extract hostname from endpoint (remove https:// and any path)
          QUAY_HOST=$(echo "${QUAY_ENDPOINT}" | sed -e 's|https\?://||' -e 's|/.*||')
          echo "üîç Quay Host: ${QUAY_HOST}"
          
          # Get the certificate from the Quay route
          echo "üì• Extracting certificate from Quay route..."
          QUAY_ROUTE_NAME=$(oc get route -n openshift-operators -l quay-component=quay-app-route -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [[ -n "${QUAY_ROUTE_NAME}" ]]; then
            echo "‚úÖ Found Quay route: ${QUAY_ROUTE_NAME}"
            
            # Extract certificate from the route
            CERT_FILE="additional-trusted-ca.pem"
            oc get route "${QUAY_ROUTE_NAME}" -n openshift-operators -o jsonpath='{.spec.tls.certificate}' > "${CERT_FILE}" 2>/dev/null || true
            
            if [[ -f "${CERT_FILE}" ]] && [[ -s "${CERT_FILE}" ]]; then
              echo "‚úÖ Certificate extracted successfully"
              echo ""
              echo "üìã Certificate Content:"
              echo "============================================"
              cat "${CERT_FILE}"
              echo "============================================"
              echo ""
              
              # Configure ROSA cluster to trust the certificate
              echo "üîß Configuring ROSA HCP cluster to trust Quay certificate..."
              if rosa edit cluster -c "${CLUSTER_NAME}" --additional-trust-bundle-file "${CERT_FILE}"; then
                echo "‚úÖ Certificate trust configured successfully for ROSA HCP cluster!"
                echo "‚ÑπÔ∏è  The cluster will now trust the Quay registry certificate"
                echo "‚ÑπÔ∏è  All nodes will be updated to trust this certificate"
                echo ""
                echo "üîç Certificate Trust Status: ‚úÖ Configured"
              else
                echo "‚ö†Ô∏è  Failed to configure certificate trust"
                echo "‚ÑπÔ∏è  You can manually configure it with:"
                echo "   rosa edit cluster -c ${CLUSTER_NAME} --additional-trust-bundle-file ${CERT_FILE}"
                echo ""
                echo "üîç Certificate Trust Status: ‚ö†Ô∏è  Manual configuration needed"
              fi
            else
              echo "‚ö†Ô∏è  Could not extract certificate from route"
              echo "‚ÑπÔ∏è  Certificate trust will need to be configured manually"
            fi
          else
            echo "‚ö†Ô∏è  Quay route not found"
            echo "‚ÑπÔ∏è  Certificate trust will need to be configured once route is available"
          fi
        fi
        
        echo ""
        echo "üîç Certificate Trust Summary:"
        echo "=========================================="
        echo "‚úÖ Certificate trust is configured AUTOMATICALLY by ansible playbook"
        echo ""
        echo "How it works for ROSA HCP:"
        echo "  1. Ansible extracts Quay registry certificate"
        echo "  2. Ansible authenticates with Red Hat OCM"
        echo "  3. Ansible runs: rosa edit cluster --additional-trust-bundle-file"
        echo "  4. OpenShift nodes will trust the Quay certificate"
        echo ""
        echo "‚ÑπÔ∏è  Note: ROSA HCP uses a different method than standard ROSA/ARO:"
        echo "  - ROSA HCP: rosa edit cluster (managed via HostedCluster CR)"
        echo "  - ARO/ROSA: images.config.openshift.io patch (managed directly)"
        echo ""
        echo "‚úÖ No manual action required!"
        echo ""