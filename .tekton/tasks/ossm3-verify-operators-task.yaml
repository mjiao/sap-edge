# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: ossm3-verify-operators
spec:
  description: >-
    Verify that Red Hat OpenShift Service Mesh 3.x operators are installed
    on the hosted cluster.
  params:
    - name: hostedClusterName
      type: string
      description: "Name of the hosted cluster"
    - name: hostedClusterNamespace
      type: string
      description: "Namespace for HostedCluster resources"
      default: "clusters"
    - name: hubKubeconfigSecretName
      type: string
      description: "Name of the Secret containing kubeconfig for hub cluster (optional, uses in-cluster config if empty)"
      default: ""
  workspaces:
    - name: source
  results:
    - name: operator-version
      description: "Installed Service Mesh 3.x operator version"
  steps:
    - name: verify-operators
      image: registry.access.redhat.com/ubi9/ubi
      timeout: "336h"
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        CLUSTER_NAME="$(params.hostedClusterName)"
        CLUSTER_NS="$(params.hostedClusterNamespace)"
        HUB_KUBECONFIG_SECRET="$(params.hubKubeconfigSecretName)"

        echo "=========================================="
        echo "OSSM3 Verify Operators Task"
        echo "=========================================="
        echo "Hosted Cluster: ${CLUSTER_NAME}"
        echo "Cluster Namespace: ${CLUSTER_NS}"
        echo "=========================================="

        # Install required tools
        echo "ðŸ“¦ Installing OpenShift CLI..."
        curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz
        tar xzf /tmp/oc.tar.gz -C /tmp
        mv /tmp/oc /usr/local/bin/
        cp /usr/local/bin/oc /usr/local/bin/kubectl
        rm -f /tmp/oc.tar.gz
        oc version --client

        # Configure hub cluster kubeconfig if provided
        if [[ -n "${HUB_KUBECONFIG_SECRET}" ]]; then
          echo "ðŸ” Extracting hub cluster kubeconfig from secret: ${HUB_KUBECONFIG_SECRET}..."
          HUB_KUBECONFIG="/tmp/hub-kubeconfig"
          if kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.kubeconfig}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "âœ… Kubeconfig extracted (key: kubeconfig)"
          elif kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.config}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "âœ… Kubeconfig extracted (key: config)"
          elif kubectl get secret "${HUB_KUBECONFIG_SECRET}" -o jsonpath='{.data.value}' 2>/dev/null | base64 -d > "${HUB_KUBECONFIG}" 2>/dev/null && [[ -s "${HUB_KUBECONFIG}" ]]; then
            echo "âœ… Kubeconfig extracted (key: value)"
          else
            echo "âŒ Failed to extract kubeconfig from secret '${HUB_KUBECONFIG_SECRET}'"
            echo "   Secret should have kubeconfig data under key 'kubeconfig', 'config', or 'value'"
            exit 1
          fi
          chmod 600 "${HUB_KUBECONFIG}"
          export KUBECONFIG="${HUB_KUBECONFIG}"
          echo "âœ… Using hub kubeconfig for cluster operations"
          oc whoami
        else
          echo "â„¹ï¸  No hub kubeconfig secret provided, using in-cluster service account"
        fi

        # Extract kubeconfig for hosted cluster
        echo "ðŸ” Extracting kubeconfig for hosted cluster..."
        KUBECONFIG_SECRET="${CLUSTER_NAME}-admin-kubeconfig"

        if ! oc get secret "${KUBECONFIG_SECRET}" -n "${CLUSTER_NS}" > /dev/null 2>&1; then
          echo "âŒ Kubeconfig secret '${KUBECONFIG_SECRET}' not found in namespace '${CLUSTER_NS}'"
          exit 1
        fi

        HOSTED_KUBECONFIG="/tmp/hosted-kubeconfig"
        oc get secret "${KUBECONFIG_SECRET}" -n "${CLUSTER_NS}" \
          -o jsonpath='{.data.kubeconfig}' | base64 -d > "${HOSTED_KUBECONFIG}"
        chmod 600 "${HOSTED_KUBECONFIG}"

        export KUBECONFIG="${HOSTED_KUBECONFIG}"

        echo "ðŸ” Verifying access to hosted cluster..."
        oc get nodes
        echo "âœ… Successfully connected to hosted cluster"

        # Wait for OLM to be ready and verify Service Mesh 3.x operator is installed
        echo ""
        echo "ðŸ” Waiting for Operator Lifecycle Manager to be ready..."
        MAX_RETRIES=30
        RETRY_INTERVAL=30
        CSV_OUTPUT=""
        for i in $(seq 1 ${MAX_RETRIES}); do
          CSV_OUTPUT=$(oc get csv -n openshift-operators 2>/dev/null || true)
          if [[ -n "${CSV_OUTPUT}" ]]; then
            echo "âœ… OLM is ready"
            break
          fi
          if [[ ${i} -eq ${MAX_RETRIES} ]]; then
            echo "âŒ OLM not ready after $((MAX_RETRIES * RETRY_INTERVAL)) seconds"
            echo "   Could not list ClusterServiceVersions in openshift-operators namespace"
            echo "   Ensure the operator lifecycle manager is running and you have cluster-admin access"
            exit 1
          fi
          echo "   Attempt ${i}/${MAX_RETRIES}: OLM not ready yet, retrying in ${RETRY_INTERVAL}s..."
          sleep ${RETRY_INTERVAL}
        done

        echo "ðŸ” Checking for Red Hat OpenShift Service Mesh 3.x operator..."

        # Search for OSSM 3.x operator (may appear as servicemeshoperator3 or sail-operator)
        OSSM3_CSV=$(echo "${CSV_OUTPUT}" | grep -iE "servicemeshoperator3|sailoperator|sail-operator|servicemesh.*3" || true)

        if [[ -z "${OSSM3_CSV}" ]]; then
          echo "âŒ Red Hat OpenShift Service Mesh 3.x operator NOT found"
          echo ""
          echo "   Available CSVs in openshift-operators namespace:"
          echo "${CSV_OUTPUT}"
          echo ""
          echo "   Please install the Service Mesh 3.x operator from OperatorHub before running this pipeline."
          exit 1
        fi

        OPERATOR_VERSION=$(echo "${OSSM3_CSV}" | awk '{print $1}' | head -1)
        echo "âœ… Service Mesh 3.x operator found: ${OPERATOR_VERSION}"
        echo ""
        echo "   Full CSV details:"
        echo "${OSSM3_CSV}"

        # Write result
        echo -n "${OPERATOR_VERSION}" > "$(results.operator-version.path)"

        echo ""
        echo "=========================================="
        echo "âœ… Operator verification completed"
        echo "=========================================="
