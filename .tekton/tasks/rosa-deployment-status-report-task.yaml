# SPDX-FileCopyrightText: 2025 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: rosa-deployment-status-report
spec:
  description: Validate pods and generate deployment status report for ROSA cluster
  params:
    - name: clusterName
      type: string
      description: "ROSA cluster name"
    - name: awsSecretName
      type: string
      description: "Name of the Kubernetes Secret containing AWS credentials"
      default: "aws-credentials-secret"
    - name: redhatTokenSecretName
      type: string
      description: "Name of the Kubernetes Secret containing Red Hat OCM token"
      default: "redhat-token-secret"
    - name: namespace
      type: string
      description: "Namespace to check pod status"
      default: "edgelm"
    - name: expectedPodCount
      type: string
      description: "Expected minimum number of pods (0 to skip validation)"
      default: "0"
    - name: platform
      type: string
      description: "Platform type (rosa)"
      default: "rosa"
  workspaces:
    - name: source
  steps:
    - name: validate-and-report
      image: registry.access.redhat.com/ubi9/ubi
      workingDir: $(workspaces.source.path)
      env:
        - name: CLUSTER_NAME
          value: "$(params.clusterName)"
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: $(params.awsSecretName)
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.awsSecretName)
              key: AWS_SECRET_ACCESS_KEY
        - name: REDHAT_OCM_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.redhatTokenSecretName)
              key: REDHAT_OCM_TOKEN
        - name: NAMESPACE
          value: "$(params.namespace)"
        - name: EXPECTED_POD_COUNT
          value: "$(params.expectedPodCount)"
        - name: PLATFORM
          value: $(params.platform)
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "üìä ROSA Deployment Status Report for cluster: ${CLUSTER_NAME}"
        echo "=============================================="

        # Install required tools
        echo "üì¶ Installing required tools..."
        dnf install -y jq tar gzip

        # Install ROSA CLI
        echo "üì¶ Installing ROSA CLI..."
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz | tar xz
        mv rosa /usr/local/bin/
        rosa version

        # Install OpenShift CLI
        echo "üì¶ Installing OpenShift CLI..."
        curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz | tar xz
        mv oc kubectl /usr/local/bin/

        # Login to ROSA
        echo "üîê Logging into ROSA..."
        rosa login --token="${REDHAT_OCM_TOKEN}"

        # Get cluster info
        echo "üìã Getting cluster information..."
        CLUSTER_INFO=$(rosa describe cluster -c "${CLUSTER_NAME}" -o json 2>/dev/null || echo '{}')
        API_URL=$(echo "$CLUSTER_INFO" | jq -r '.api.url // "N/A"')
        CONSOLE_URL=$(echo "$CLUSTER_INFO" | jq -r '.console.url // "N/A"')
        CLUSTER_STATE=$(echo "$CLUSTER_INFO" | jq -r '.state // "unknown"')
        CLUSTER_VERSION=$(echo "$CLUSTER_INFO" | jq -r '.version.raw_id // "N/A"')
        AWS_REGION=$(echo "$CLUSTER_INFO" | jq -r '.region.id // "N/A"')

        echo ""
        echo "üî¥ ROSA Cluster Status:"
        echo "  Cluster Name: ${CLUSTER_NAME}"
        echo "  State: ${CLUSTER_STATE}"
        echo "  Version: ${CLUSTER_VERSION}"
        echo "  AWS Region: ${AWS_REGION}"
        echo "  API URL: ${API_URL}"
        echo "  Console URL: ${CONSOLE_URL}"
        echo ""

        # Login to cluster
        echo "üîê Logging into OpenShift cluster..."
        ADMIN_CREDS=$(rosa describe admin -c "${CLUSTER_NAME}" -o json 2>/dev/null || echo '{}')
        ADMIN_USER=$(echo "$ADMIN_CREDS" | jq -r '.username // empty')
        ADMIN_PASS=$(echo "$ADMIN_CREDS" | jq -r '.password // empty')

        if [ -z "$ADMIN_USER" ] || [ -z "$ADMIN_PASS" ]; then
          echo "‚ö†Ô∏è No admin credentials found, creating admin user..."
          rosa create admin -c "${CLUSTER_NAME}" --yes 2>/dev/null || true
          sleep 30
          ADMIN_CREDS=$(rosa describe admin -c "${CLUSTER_NAME}" -o json)
          ADMIN_USER=$(echo "$ADMIN_CREDS" | jq -r '.username')
          ADMIN_PASS=$(echo "$ADMIN_CREDS" | jq -r '.password')
        fi

        oc login "${API_URL}" --username="${ADMIN_USER}" --password="${ADMIN_PASS}" --insecure-skip-tls-verify=true

        echo "üñ•Ô∏è Node Status:"
        oc get nodes -o wide
        echo ""

        # Namespace pod validation
        echo "üîç Checking namespace '${NAMESPACE}'..."
        POD_VALIDATION_STATUS="SKIPPED"

        if [ "${EXPECTED_POD_COUNT}" -gt 0 ]; then
          if ! oc get namespace "${NAMESPACE}" >/dev/null 2>&1; then
            echo "‚ùå Namespace '${NAMESPACE}' does not exist"
            POD_VALIDATION_STATUS="FAILED"
          else
            echo "‚úÖ Namespace '${NAMESPACE}' exists"

            # Get pod info
            PODS_INFO=$(oc get pods -n "${NAMESPACE}" -o json 2>/dev/null || echo '{"items":[]}')
            TOTAL_PODS=$(echo "$PODS_INFO" | jq -r '.items | length')
            RUNNING_PODS=$(echo "$PODS_INFO" | jq -r '[.items[] | select(.status.phase == "Running")] | length')
            COMPLETED_PODS=$(echo "$PODS_INFO" | jq -r '[.items[] | select(.status.phase == "Succeeded")] | length')
            FAILED_PODS=$(echo "$PODS_INFO" | jq -r '[.items[] | select(.status.phase == "Failed")] | length')

            echo "  Total pods: ${TOTAL_PODS} (expected minimum: ${EXPECTED_POD_COUNT})"
            echo "  Running: ${RUNNING_PODS}"
            echo "  Completed: ${COMPLETED_PODS}"
            echo "  Failed: ${FAILED_PODS}"
            echo ""
            oc get pods -n "${NAMESPACE}" -o wide
            echo ""

            ACCEPTABLE_PODS=$((RUNNING_PODS + COMPLETED_PODS))
            if [ "${ACCEPTABLE_PODS}" -ge "${EXPECTED_POD_COUNT}" ] && [ "${FAILED_PODS}" -eq 0 ]; then
              echo "‚úÖ Pod validation passed: ${ACCEPTABLE_PODS} pods in acceptable state"
              POD_VALIDATION_STATUS="PASSED"
            else
              echo "‚ùå Pod validation failed: expected ${EXPECTED_POD_COUNT}, got ${ACCEPTABLE_PODS} acceptable (${FAILED_PODS} failed)"
              POD_VALIDATION_STATUS="FAILED"
            fi
          fi
        else
          echo "‚ÑπÔ∏è Pod validation skipped (expectedPodCount=0)"
          if oc get namespace "${NAMESPACE}" >/dev/null 2>&1; then
            oc get pods -n "${NAMESPACE}" -o wide 2>/dev/null || echo "  No pods found"
          fi
        fi
        echo ""

        # Key namespaces
        echo "üìÅ Key Namespaces:"
        oc get namespaces | grep -E 'edgelm|quay|openshift-operators' || echo "  No matching namespaces found"
        echo ""

        # Generate status file
        FINAL_STATUS="SUCCESS"
        if [ "${POD_VALIDATION_STATUS}" = "FAILED" ]; then
          FINAL_STATUS="FAILED"
        fi
        jq -n \
          --arg platform "${PLATFORM}" \
          --arg cluster_name "${CLUSTER_NAME}" \
          --arg cluster_state "${CLUSTER_STATE}" \
          --arg cluster_version "${CLUSTER_VERSION}" \
          --arg aws_region "${AWS_REGION}" \
          --arg api_url "${API_URL}" \
          --arg console_url "${CONSOLE_URL}" \
          --arg namespace "${NAMESPACE}" \
          --arg pod_status "${POD_VALIDATION_STATUS}" \
          --arg timestamp "$(date -Iseconds)" \
          --arg status "${FINAL_STATUS}" \
          '{platform: $platform, cluster_name: $cluster_name, cluster_state: $cluster_state, cluster_version: $cluster_version, aws_region: $aws_region, api_url: $api_url, console_url: $console_url, namespace_validated: $namespace, pod_validation_status: $pod_status, completion_timestamp: $timestamp, status: $status}' \
          > final-deployment-status.json

        echo "üìä Deployment Summary"
        echo "  Platform - ${PLATFORM}"
        echo "  Cluster - ${CLUSTER_NAME}"
        echo "  Pod Validation - ${POD_VALIDATION_STATUS}"
        echo "  Timestamp - $(date -Iseconds)"
        echo ""

        # Exit based on validation result
        if [ "${POD_VALIDATION_STATUS}" = "FAILED" ]; then
          echo "‚ùå Deployment validation FAILED"
          exit 1
        fi

        echo "‚úÖ Deployment status report completed successfully!"
