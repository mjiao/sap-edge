<!--
SPDX-FileCopyrightText: 2026 SAP edge team
SPDX-FileContributor: Manjun Jiao (@mjiao)

SPDX-License-Identifier: Apache-2.0
-->

# Valkey Cluster External Service for SAP EIC

Deploy Valkey (Redis-compatible) in cluster mode (1 master + N-1 read replicas) with TLS on OpenShift for SAP Edge Integration Cell.

## Prerequisites

- `oc` CLI logged into your OpenShift cluster
- `helm` v3 installed
- `cluster-admin` permissions

## Directory Structure

```
external-valkey-cluster/
├── charts/
│   ├── redhat-valkey-imagestreams/
│   │   └── src/                      # ImageStreams helm chart
│   └── redhat-valkey-cluster/
│       └── src/                      # Valkey cluster helm chart
├── deploy_valkey.sh                  # Automated deployment script
├── get_valkey_access.sh              # Get connection details
├── cleanup_valkey.sh                 # Cleanup script
└── README.md
```

## Architecture

This chart deploys Valkey in replication mode using a StatefulSet:

- **Pod 0** is always the master (read/write)
- **Pods 1 through N-1** are read replicas

Three services are created:

| Service | Description |
|---------|-------------|
| `valkey-master` | Routes to the master pod only (use for writes) |
| `valkey-read` | Routes to all pods (use for load-balanced reads) |
| `valkey-headless` | Headless service for StatefulSet DNS resolution |

## Quick Start

### Automated Deployment

```bash
# Deploy Valkey cluster with TLS (password optional, default: testp)
bash deploy_valkey.sh

# Deploy with custom password
bash deploy_valkey.sh --password <your-password>

# Deploy to custom namespace
bash deploy_valkey.sh --namespace my-valkey --password <your-password>

# Dry-run to preview
bash deploy_valkey.sh --dry-run
```

### Get Access Details

```bash
bash get_valkey_access.sh

# For custom namespace
bash get_valkey_access.sh --namespace my-valkey
```

### Cleanup

```bash
# Interactive cleanup
bash cleanup_valkey.sh

# Force cleanup (no prompts)
bash cleanup_valkey.sh --force

# Dry-run
bash cleanup_valkey.sh --dry-run
```

## Manual Deployment

### 1. Install ImageStreams Chart

```bash
oc new-project sap-eic-external-valkey-cluster

helm install redhat-valkey-imagestreams \
  ./charts/redhat-valkey-imagestreams/src \
  -n sap-eic-external-valkey-cluster
```

### 2. Install Valkey Cluster Chart

```bash
# TLS is always enabled (required by SAP EIC)
helm install valkey-cluster \
  ./charts/redhat-valkey-cluster/src \
  -n sap-eic-external-valkey-cluster \
  --set valkey_password=<your-password>
```

### 3. Verify Deployment

```bash
# Check all pods are running
oc get pods -l name=valkey -n sap-eic-external-valkey-cluster

# Check services
oc get svc -l template=valkey-cluster-template -n sap-eic-external-valkey-cluster

# Check TLS secret (auto-generated by OpenShift Service CA)
oc get secret valkey-tls -n sap-eic-external-valkey-cluster

# Check Service CA ConfigMap
oc get configmap valkey-service-ca -n sap-eic-external-valkey-cluster

# Run helm test
helm test valkey-cluster -n sap-eic-external-valkey-cluster
```

## Connection Details

The TLS certificate is generated for the headless service, so clients must use
headless service DNS names to match the certificate SANs.

### Write connections (master only)

- **Host**: `valkey-0.valkey-headless.sap-eic-external-valkey-cluster.svc.cluster.local`
- **Port**: `6380` (TLS)

```bash
valkey-cli -h valkey-0.valkey-headless.sap-eic-external-valkey-cluster.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <your-password>
```

### Read connections (load-balanced)

- **Host**: `valkey-headless.sap-eic-external-valkey-cluster.svc.cluster.local`
- **Port**: `6380` (TLS)

```bash
valkey-cli -h valkey-headless.sap-eic-external-valkey-cluster.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <your-password>
```

### Mount CA Certificate in Application

```yaml
volumeMounts:
  - name: service-ca
    mountPath: /etc/ssl/service-ca
    readOnly: true
volumes:
  - name: service-ca
    configMap:
      name: valkey-service-ca
```

No client certificate is required (`--tls-auth-clients` is set to `no`).

## Upgrade

```bash
helm upgrade valkey-cluster \
  ./charts/redhat-valkey-cluster/src \
  -n sap-eic-external-valkey-cluster
```

## Manual Cleanup

```bash
helm uninstall valkey-cluster -n sap-eic-external-valkey-cluster
helm uninstall redhat-valkey-imagestreams -n sap-eic-external-valkey-cluster
oc delete pvc -l template=valkey-cluster-template -n sap-eic-external-valkey-cluster
oc delete namespace sap-eic-external-valkey-cluster
```
