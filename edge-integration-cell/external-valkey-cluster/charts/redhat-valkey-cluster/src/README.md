# Valkey Cluster Helm Chart

A Helm chart for deploying [Valkey](https://github/sclorg/valkey-container) in Redis Cluster mode (hash slot sharding) on OpenShift.

For more information about helm charts see the official [Helm Charts Documentation](https://helm.sh/).

You need to have access to a cluster for each operation with OpenShift 4, like deploying and testing.

## Architecture

This chart deploys Valkey in Redis Cluster mode using a StatefulSet:

- All pods start as independent Valkey nodes with `--cluster-enabled yes`
- After pods are ready, a Helm post-install hook Job forms the cluster via `valkey-cli --cluster create`
- Hash slots (0-16383) are distributed evenly across all nodes
- Each node is a master responsible for a subset of hash slots
- Minimum 3 nodes required for Redis Cluster

Two services are created:

| Service | Description |
|---------|-------------|
| `<name>` | ClusterIP service routing to all pods (use as seed for cluster discovery) |
| `<name>-headless` | Headless service for StatefulSet DNS resolution and TLS certificate SANs |

## Values

| Value | Description | Default |
|-------|-------------|---------|
| `database_service_name` | Base name for all resources. | `valkey` |
| `replicas` | Number of cluster nodes (minimum 3). | `3` |
| `valkey_password` | Password for Valkey authentication. | |
| `valkey_version` | Valkey ImageStream tag (8-el10, 8-el9, or latest). | `8-el10` |
| `namespace` | OpenShift namespace. | `valkey-cluster-testing` |
| `memory_limit` | Memory limit per pod. | `512Mi` |
| `pvc.volume_capacity` | Persistent volume size per pod. | `1Gi` |
| `pvc.netapp_nfs` | Use NetApp NFS storage class. | `false` |
| `pvc.app_code` | Application code label for NetApp NFS PVC. | `something` |
| `tls.enabled` | Enable TLS encryption. | `true` |
| `tls.autoGenerated` | Use OpenShift Service CA for auto-generated certs. | `true` |
| `tls.secretName` | Name of the TLS secret. | `valkey-tls` |

## TLS Support

When `tls.enabled` and `tls.autoGenerated` are both `true` (the default):

1. The headless Service is annotated with `service.beta.openshift.io/serving-cert-secret-name`, triggering OpenShift to auto-generate a TLS certificate with wildcard SANs covering all pod DNS names.
2. The TLS secret is mounted into every pod at `/tls/`.
3. Valkey listens on port **6380** for TLS connections (port 6379 remains available for non-TLS).
4. Cluster bus communication uses TLS (`--tls-cluster yes`).
5. Each node announces its hostname via `--cluster-announce-hostname` so that `CLUSTER SLOTS` returns hostnames matching the TLS certificate SANs.
6. A ConfigMap (`<name>-service-ca`) is created with the Service CA bundle for client trust.

## Connecting from a Client Application

**Important:** The TLS certificate SANs only cover the headless service DNS names.
Clients must connect using headless service hostnames to pass TLS verification.

Use a Redis Cluster client (e.g., Go `redis.ClusterClient`) that auto-discovers
nodes via `CLUSTER SLOTS`:

```bash
valkey-cli -h valkey-0.valkey-headless.<namespace>.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <password> -c
```

Note: Use `-c` flag for cluster mode to follow `MOVED` redirections.

### Mounting the CA bundle

```yaml
volumeMounts:
  - name: service-ca
    mountPath: /etc/ssl/service-ca
    readOnly: true
volumes:
  - name: service-ca
    configMap:
      name: valkey-service-ca
```

No client certificate is required (`--tls-auth-clients` is set to `no`).
