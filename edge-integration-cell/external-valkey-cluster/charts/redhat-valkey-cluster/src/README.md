# Valkey Cluster Helm Chart

A Helm chart for deploying [Valkey](https://github/sclorg/valkey-container) with replication (1 master + N read replicas) on OpenShift.

For more information about helm charts see the official [Helm Charts Documentation](https://helm.sh/).

You need to have access to a cluster for each operation with OpenShift 4, like deploying and testing.

## Architecture

This chart deploys Valkey in replication mode using a StatefulSet:

- **Pod 0** is always the master (read/write)
- **Pods 1 through N-1** are read replicas

Three services are created:

| Service | Description |
|---------|-------------|
| `<name>-master` | Routes to the master pod only (use for writes) |
| `<name>-read` | Routes to all pods (use for load-balanced reads) |
| `<name>-headless` | Headless service for StatefulSet DNS resolution |

## Values

| Value | Description | Default |
|-------|-------------|---------|
| `database_service_name` | Base name for all resources. | `valkey` |
| `replicas` | Total number of pods (1 master + N-1 replicas). | `3` |
| `valkey_password` | Password for Valkey authentication. | |
| `valkey_version` | Valkey image tag (8-el10, 8-el9, or latest). | `8-el10` |
| `namespace` | OpenShift namespace for ImageStream. | `valkey-cluster-testing` |
| `memory_limit` | Memory limit per pod. | `512Mi` |
| `pvc.volume_capacity` | Persistent volume size per pod. | `1Gi` |
| `pvc.netapp_nfs` | Use NetApp NFS storage class. | `false` |
| `pvc.app_code` | Application code label for NetApp NFS PVC. | `something` |
| `tls.enabled` | Enable TLS encryption. | `true` |
| `tls.autoGenerated` | Use OpenShift Service CA for auto-generated certs. | `true` |
| `tls.secretName` | Name of the TLS secret. | `valkey-tls` |

## TLS Support

When `tls.enabled` and `tls.autoGenerated` are both `true` (the default):

1. The headless Service is annotated with `service.beta.openshift.io/serving-cert-secret-name`, triggering OpenShift to auto-generate a TLS certificate with wildcard SANs covering all pod DNS names.
2. The TLS secret is mounted into every pod at `/tls/`.
3. Valkey listens on port **6380** for TLS connections (port 6379 remains available for non-TLS).
4. Replication traffic between master and replicas uses TLS (`--tls-replication yes`).
5. A ConfigMap (`<name>-service-ca`) is created with the Service CA bundle for client trust.

## Connecting from a Client Application

### Write connections (master only)

Use the `<name>-master` service:

```bash
valkey-cli -h valkey-master.<namespace>.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <password>
```

### Read connections (load-balanced)

Use the `<name>-read` service:

```bash
valkey-cli -h valkey-read.<namespace>.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <password>
```

### Mounting the CA bundle

```yaml
volumeMounts:
  - name: service-ca
    mountPath: /etc/ssl/service-ca
    readOnly: true
volumes:
  - name: service-ca
    configMap:
      name: valkey-service-ca
```

No client certificate is required (`--tls-auth-clients` is set to `no`).
