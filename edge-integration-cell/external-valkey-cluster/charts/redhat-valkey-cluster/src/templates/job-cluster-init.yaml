apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.database_service_name }}-cluster-init
  labels:
    template: valkey-cluster-template
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        name: {{ .Values.database_service_name }}-cluster-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: cluster-init
        image: image-registry.openshift-image-registry.svc:5000/{{ .Release.Namespace }}/valkey:{{ .Values.valkey_version }}
        imagePullPolicy: IfNotPresent
        env:
        - name: VALKEY_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{ .Values.database_service_name }}
        command:
        - /bin/bash
        - -ec
        - |
          {{- if .Values.tls.enabled }}
          CLI_TLS="--tls --cacert /service-ca/service-ca.crt -p 6380"
          PORT=6380
          {{- else }}
          CLI_TLS=""
          PORT=6379
          {{- end }}

          {{- $svcName := .Values.database_service_name }}
          {{- $ns := .Release.Namespace }}

          NODES=""
          {{- range $i := until (int .Values.replicas) }}
          NODES="${NODES} {{ $svcName }}-{{ $i }}.{{ $svcName }}-headless.{{ $ns }}.svc.cluster.local:${PORT}"
          {{- end }}

          echo "==> Waiting for all nodes to respond to PING..."
          {{- range $i := until (int .Values.replicas) }}
          HOST="{{ $svcName }}-{{ $i }}.{{ $svcName }}-headless.{{ $ns }}.svc.cluster.local"
          until valkey-cli -h "$HOST" -a "$VALKEY_PASSWORD" $CLI_TLS ping 2>/dev/null | grep -q PONG; do
            echo "Waiting for $HOST..."
            sleep 2
          done
          echo "$HOST is ready"
          {{- end }}

          echo "==> Checking if cluster already exists..."
          FIRST_NODE="{{ $svcName }}-0.{{ $svcName }}-headless.{{ $ns }}.svc.cluster.local"
          CLUSTER_INFO=$(valkey-cli -h "$FIRST_NODE" -a "$VALKEY_PASSWORD" $CLI_TLS CLUSTER INFO 2>/dev/null || echo "")
          if echo "$CLUSTER_INFO" | grep -q "cluster_state:ok"; then
            echo "==> Cluster already formed, verifying..."
            valkey-cli -h "$FIRST_NODE" -a "$VALKEY_PASSWORD" $CLI_TLS CLUSTER NODES
            echo "==> Cluster is healthy. Nothing to do."
            exit 0
          fi

          echo "==> Creating cluster with nodes:${NODES}"
          valkey-cli --cluster create ${NODES} \
            -a "$VALKEY_PASSWORD" \
            {{- if .Values.tls.enabled }}
            --tls --cacert /service-ca/service-ca.crt \
            {{- end }}
            --cluster-yes

          echo "==> Verifying cluster formation..."
          sleep 3
          valkey-cli -h "$FIRST_NODE" -a "$VALKEY_PASSWORD" $CLI_TLS CLUSTER INFO
          valkey-cli -h "$FIRST_NODE" -a "$VALKEY_PASSWORD" $CLI_TLS CLUSTER NODES
          echo "==> Cluster initialization complete."
        {{- if .Values.tls.enabled }}
        volumeMounts:
        - mountPath: /service-ca
          name: service-ca
          readOnly: true
        {{- end }}
      {{- if .Values.tls.enabled }}
      volumes:
      - name: service-ca
        configMap:
          name: {{ .Values.database_service_name }}-service-ca
      {{- end }}
