<!--
SPDX-FileCopyrightText: 2026 SAP edge team
SPDX-FileContributor: Manjun Jiao (@mjiao)

SPDX-License-Identifier: Apache-2.0
-->

# Valkey External Service for SAP EIC

Deploy Valkey (Redis-compatible) with TLS on OpenShift for SAP Edge Integration Cell.

## Prerequisites

- `oc` CLI logged into your OpenShift cluster
- `helm` v3 installed
- `cluster-admin` permissions

## Directory Structure

```
external-valkey/
├── charts/
│   ├── redhat-valkey-imagestreams/
│   │   └── src/                      # ImageStreams helm chart
│   └── redhat-valkey-persistent/
│       └── src/                      # Valkey deployment helm chart
├── deploy_valkey.sh                  # Automated deployment script
├── get_valkey_access.sh              # Get connection details
├── cleanup_valkey.sh                 # Cleanup script
└── README.md
```

## Quick Start

### Automated Deployment

```bash
# Deploy Valkey with TLS (password optional, default: testp)
bash deploy_valkey.sh

# Deploy with custom password
bash deploy_valkey.sh --password <your-password>

# Deploy to custom namespace
bash deploy_valkey.sh --namespace my-valkey --password <your-password>

# Dry-run to preview
bash deploy_valkey.sh --dry-run
```

### Get Access Details

```bash
bash get_valkey_access.sh

# For custom namespace
bash get_valkey_access.sh --namespace my-valkey
```

### Cleanup

```bash
# Interactive cleanup
bash cleanup_valkey.sh

# Force cleanup (no prompts)
bash cleanup_valkey.sh --force

# Dry-run
bash cleanup_valkey.sh --dry-run
```

## Manual Deployment

### 1. Install ImageStreams Chart

```bash
oc new-project sap-eic-external-valkey

helm install redhat-valkey-imagestreams \
  ./charts/redhat-valkey-imagestreams/src \
  -n sap-eic-external-valkey
```

### 2. Install Valkey Chart

```bash
# TLS is always enabled (required by SAP EIC)
helm install valkey \
  ./charts/redhat-valkey-persistent/src \
  -n sap-eic-external-valkey \
  --set valkey_password=<your-password>
```

### 3. Verify Deployment

```bash
# Check pod is running
oc get pods -l name=valkey -n sap-eic-external-valkey

# Check TLS secret (auto-generated by OpenShift Service CA)
oc get secret valkey-tls -n sap-eic-external-valkey

# Check Service CA ConfigMap
oc get configmap valkey-service-ca -n sap-eic-external-valkey

# Run helm test
helm test valkey -n sap-eic-external-valkey
```

## Connection Details

- **Host**: `valkey.sap-eic-external-valkey.svc.cluster.local`
- **Port**: `6380` (TLS)
- **TLS**: enabled (required by SAP EIC)
- **CA cert**: From `valkey-service-ca` ConfigMap

### Mount CA Certificate in Application

```yaml
volumeMounts:
  - name: service-ca
    mountPath: /etc/ssl/service-ca
    readOnly: true
volumes:
  - name: service-ca
    configMap:
      name: valkey-service-ca
```

### Test Connection

```bash
valkey-cli -h valkey.sap-eic-external-valkey.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <your-password> ping
```

## Upgrade

```bash
helm upgrade valkey \
  ./charts/redhat-valkey-persistent/src \
  -n sap-eic-external-valkey
```

## Manual Cleanup

```bash
helm uninstall valkey -n sap-eic-external-valkey
helm uninstall redhat-valkey-imagestreams -n sap-eic-external-valkey
oc delete namespace sap-eic-external-valkey
```
