# SPDX-FileCopyrightText: 2024 SAP edge team
# SPDX-FileContributor: Manjun Jiao (@mjiao)
#
# SPDX-License-Identifier: Apache-2.0

---
- name: Deploy Quay Registry on OpenShift (ARO/ROSA)
  hosts: localhost
  gather_facts: false
  vars:
    # Platform can be 'aro' or 'rosa'
    platform: "{{ platform | default('aro') }}"
    cluster_name: "{{ cluster_name | mandatory }}"

    # Storage configuration
    storage_config:
      aro:
        type: azure
        account_name: "{{ azure_storage_account_name | default('') }}"
        account_key: "{{ azure_storage_account_key | default('') }}"
        container: "{{ azure_storage_container | default('quay-registry') }}"
      rosa:
        type: s3
        bucket_name: "{{ s3_bucket_name | default('') }}"
        region: "{{ s3_region | default('us-east-1') }}"
        host: "{{ s3_host | default('s3.amazonaws.com') }}"
        access_key: "{{ aws_access_key_id | default(lookup('env', 'AWS_ACCESS_KEY_ID')) | default('') }}"
        secret_key: "{{ aws_secret_access_key | default(lookup('env', 'AWS_SECRET_ACCESS_KEY')) | default('') }}"

    # Quay configuration
    quay:
      namespace: openshift-operators
      registry_name: test-registry
      admin_username: quayadmin
      admin_password: "{{ quay_admin_password | default('') }}"
      admin_email: "{{ quay_admin_email | default('') }}"

  tasks:
    - name: Validate platform parameter
      assert:
        that:
          - platform in ['aro', 'rosa']
        fail_msg: "Platform must be 'aro' or 'rosa', got '{{ platform }}'"

    - name: Include platform-specific storage tasks
      include_tasks: "tasks/storage/{{ platform }}-storage.yml"
      tags: storage

    - name: Deploy Quay operator
      include_tasks: tasks/quay/deploy-operator.yml
      tags: operator

    - name: Configure Quay with storage backend
      include_tasks: tasks/quay/configure-storage.yml
      tags: config

    - name: Deploy Quay registry instance
      include_tasks: tasks/quay/deploy-registry.yml
      tags: registry

    - name: Wait for Quay to be ready
      include_tasks: tasks/quay/wait-ready.yml
      tags: wait

    - name: TRUST TEST - Direct trust configuration
      debug:
        msg: "üîç Direct trust configuration in main playbook"
      tags: trust

    - name: Get Quay registry endpoint for trust
      kubernetes.core.k8s_info:
        api_version: quay.redhat.com/v1
        kind: QuayRegistry
        name: "{{ quay.registry_name }}"
        namespace: "{{ quay.namespace }}"
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      register: quay_registry_trust
      tags: trust

    - name: Extract registry hostname for trust
      set_fact:
        trust_registry_endpoint: "{{ quay_registry_trust.resources[0].status.registryEndpoint }}"
        trust_registry_hostname: "{{ quay_registry_trust.resources[0].status.registryEndpoint | regex_replace('^https://', '') }}"
      tags: trust

    - name: Display registry information for trust
      debug:
        msg:
          - "Registry Endpoint: {{ trust_registry_endpoint }}"
          - "Registry Hostname: {{ trust_registry_hostname }}"
      tags: trust

    - name: Extract OpenShift ingress CA certificate for trust
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: router-ca
        namespace: openshift-ingress-operator
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      register: router_ca_secret_trust
      tags: trust

    - name: Decode CA certificate for trust
      set_fact:
        trust_ca_bundle: "{{ router_ca_secret_trust.resources[0].data['tls.crt'] | b64decode }}"
      when: "'tls.crt' in router_ca_secret_trust.resources[0].data"
      tags: trust

    - name: Create registry key for ConfigMap
      set_fact:
        registry_key: "{{ trust_registry_hostname | regex_replace(':', '..') }}"
      tags: trust

    - name: Create or update trusted CA ConfigMap
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: trusted-registry-cabundles
            namespace: openshift-config
          data: >-
            {{
              {registry_key: trust_ca_bundle}
            }}
        state: present
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      when: trust_ca_bundle is defined
      tags: trust

    - name: Update cluster image configuration with trust (ARO)
      kubernetes.core.k8s:
        definition:
          apiVersion: config.openshift.io/v1
          kind: Image
          metadata:
            name: cluster
          spec:
            additionalTrustedCA:
              name: trusted-registry-cabundles
        state: present
        merge_type: merge
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      when:
        - trust_ca_bundle is defined
        - platform == 'aro'
      tags: trust

    - name: Configure trust bundle for ROSA HCP cluster
      block:
        - name: Write certificate to file for ROSA CLI
          copy:
            content: "{{ trust_ca_bundle }}"
            dest: "/tmp/quay-registry-ca.crt"
            mode: '0644'

        - name: Verify ROSA CLI is available
          command: /usr/local/bin/rosa version
          register: rosa_version_check
          changed_when: false
          failed_when: false

        - name: Display ROSA CLI version
          debug:
            msg: "ROSA CLI version: {{ rosa_version_check.stdout }}"
          when: rosa_version_check.rc == 0

        - name: Authenticate with Red Hat OCM
          command: >
            /usr/local/bin/rosa login
            --token={{ lookup('env', 'REDHAT_OCM_TOKEN') }}
          register: rosa_login_result
          changed_when: false

        - name: Apply trust bundle to ROSA HCP cluster
          command: >
            /usr/local/bin/rosa edit cluster
            --cluster {{ cluster_name }}
            --additional-trust-bundle-file /tmp/quay-registry-ca.crt
            --yes
          register: rosa_trust_result

        - name: Display ROSA trust configuration result
          debug:
            msg:
              - "‚úÖ ROSA HCP trust bundle configured successfully"
              - "Registry: {{ trust_registry_hostname }}"
              - "Method: rosa edit cluster --additional-trust-bundle-file"
              - "Certificate saved to: /tmp/quay-registry-ca.crt"

        - name: Clean up temporary certificate file
          file:
            path: "/tmp/quay-registry-ca.crt"
            state: absent
      rescue:
        - name: Handle ROSA trust configuration failure
          debug:
            msg:
              - "‚ö†Ô∏è  ROSA trust configuration failed"
              - "This is expected if:"
              - "  - ROSA CLI is not available"
              - "  - OCM token is invalid or expired"
              - "  - Cluster is not ROSA HCP"
              - "Error: {{ rosa_trust_result.stderr | default('Unknown') }}"

        - name: Clean up temporary certificate file on failure
          file:
            path: "/tmp/quay-registry-ca.crt"
            state: absent
      when:
        - trust_ca_bundle is defined
        - platform == 'rosa'
      tags: trust

    - name: Display trust configuration results (ARO)
      debug:
        msg:
          - "‚úÖ Certificate trust configured successfully"
          - "Registry: {{ trust_registry_hostname }}"
          - "ConfigMap: trusted-registry-cabundles created in openshift-config"
          - "images.config.openshift.io/cluster updated"
          - "‚ö†Ô∏è  Note: OpenShift nodes may need to restart"
      when:
        - trust_ca_bundle is defined
        - platform == 'aro'
      tags: trust

    - name: Create admin user
      include_tasks: tasks/quay/create-admin.yml
      tags: admin

    - name: Verify deployment
      include_tasks: tasks/quay/verify-deployment.yml
      tags: verify
